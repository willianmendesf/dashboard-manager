<div class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <h1>Empréstimo de Livros</h1>
      <p class="subtitle">Realize o empréstimo de um livro informando seu telefone</p>
      <a routerLink="/landing" class="back-link">← Voltar</a>
    </div>

    <!-- Step 1: Telefone -->
    @if (step === 1) {
      <form (ngSubmit)="requestCode()" class="auth-form">
        <div class="form-group">
          <label for="phone">Telefone *</label>
          <input 
            id="phone" 
            type="text" 
            [(ngModel)]="phone" 
            name="phone" 
            [mask]="'(00) 00000-0000'"
            [dropSpecialCharacters]="false"
            class="form-control"
            placeholder="(00) 00000-0000"
            [disabled]="isLoading"
            required>
        </div>

        <button type="submit" class="btn-primary btn-block" [disabled]="isLoading || !isPhoneValid()">
          {{ isLoading ? 'Enviando...' : 'Receber Código de Acesso' }}
        </button>
      </form>
    }

    <!-- Step 2: Código OTP -->
    @if (step === 2) {
      <form (ngSubmit)="validateCode()" class="auth-form">
        <div class="alert-info">
          Código enviado para <strong>{{ phone }}</strong>
          <a (click)="step = 1" class="change-number">Alterar</a>
        </div>

        <div class="form-group">
          <label for="code">Código de Acesso *</label>
          <input 
            id="code" 
            type="text" 
            [(ngModel)]="code" 
            name="code" 
            [mask]="'000000'"
            class="form-control code-input"
            placeholder="XXXXXX"
            maxlength="6"
            [disabled]="isLoading"
            required>
        </div>

        <button type="submit" class="btn-primary btn-block" [disabled]="isLoading || !code || code.length !== 6">
          {{ isLoading ? 'Validando...' : 'Validar Código' }}
        </button>
      </form>
    }

    <!-- Step 3: Seleção de Livro -->
    @if (step === 3) {
      <form [formGroup]="loanForm" (ngSubmit)="onSubmit()" class="auth-form">
        @if (memberName) {
          <div class="member-info">
            <p class="member-name-label">Olá, <strong>{{ memberName }}</strong>!</p>
            <p class="member-name-subtitle">Confirme se este é o seu nome antes de continuar.</p>
          </div>
        }
        
        <div class="form-group">
          <label>Selecione um livro disponível *</label>
          @if (isLoadingBooks) {
            <div class="loading-books">Carregando livros...</div>
          } @else if (availableBooks.length === 0) {
            <div class="no-books">Nenhum livro disponível no momento.</div>
          } @else {
            <div class="books-grid">
              @for (book of availableBooks; track book.id) {
                <div 
                  class="book-card"
                  [class.selected]="selectedBook?.id === book.id"
                  (click)="selectBook(book)"
                >
                  <div class="book-image">
                    <img 
                      [src]="getBookImageUrl(book)" 
                      [alt]="book.titulo" 
                      (error)="$event.target.src='./img/avatar-default.png'"
                      onerror="this.src='./img/avatar-default.png'"
                    />
                  </div>
                  <div class="book-info">
                    <h3>{{ book.titulo }}</h3>
                    <p class="book-quantity">Disponível: {{ book.quantidadeDisponivel }} de {{ book.quantidadeTotal }}</p>
                  </div>
                </div>
              }
            </div>
          }
          @if (loanForm.get('bookId')?.invalid && loanForm.get('bookId')?.touched) {
            <small class="error-text">Selecione um livro</small>
          }
        </div>

        @if (errorMessage) {
          <div class="alert alert-error">
            {{ errorMessage }}
          </div>
        }

        @if (successMessage) {
          <div class="alert alert-success">
            {{ successMessage }}
          </div>
        }

        <button
          type="submit"
          class="btn-primary btn-block"
          [disabled]="loanForm.invalid || isLoading || isLoadingBooks"
        >
          @if (isLoading) {
            Registrando empréstimo...
          } @else {
            Registrar Empréstimo
          }
        </button>
      </form>
    }
  </div>
</div>

