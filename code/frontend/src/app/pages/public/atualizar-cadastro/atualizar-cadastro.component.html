<div class="auth-container">
  <div class="auth-card">
    <div class="auth-header">
      <h1>Atualização Cadastral</h1>
      <p class="subtitle">Atualize seus dados cadastrais informando seu Telefone</p>
      @if (!showEditForm) {
        <a routerLink="/landing" class="back-link">← Voltar</a>
      }
    </div>

    @if (!showEditForm) {
      @if (step === 1) {
        <form (ngSubmit)="requestCode()" class="auth-form">
          <div class="form-group">
            <label for="phone">Telefone *</label>
            <input 
              id="phone" 
              type="text" 
              [(ngModel)]="phone" 
              name="phone" 
              [mask]="'(00) 00000-0000'"
              [dropSpecialCharacters]="false"
              class="form-control"
              placeholder="(00) 00000-0000"
              [disabled]="isLoading"
              required>
          </div>

          <button type="submit" class="btn-primary btn-block" [disabled]="isLoading || !isPhoneValid()">
            {{ isLoading ? 'Enviando...' : 'Receber Código de Acesso' }}
          </button>
        </form>
      }

      @if (step === 2) {
        <form (ngSubmit)="validateCode()" class="auth-form">
          <div class="alert-info">
            Código enviado para <strong>{{ phone }}</strong>
            <a (click)="step = 1" class="change-number">Alterar</a>
          </div>

          <div class="form-group">
            <label for="code">Código de Acesso *</label>
            <input 
              id="code" 
              type="text" 
              [(ngModel)]="code" 
              name="code" 
              [mask]="'000000'"
              class="form-control code-input"
              placeholder="XXXXXX"
              maxlength="6"
              [disabled]="isLoading"
              required>
          </div>

          <button type="submit" class="btn-primary btn-block" [disabled]="isLoading || !code || code.length !== 6">
            {{ isLoading ? 'Validando...' : 'Acessar Meus Dados' }}
          </button>
        </form>
      }
    }

    @if (showEditForm && foundMember) {
      <div class="edit-section">
        <div class="edit-header">
          <h2>Seus Dados Cadastrais</h2>
          <button type="button" class="btn-link" (click)="backToSearch()">
            ← Buscar outro telefone
          </button>
        </div>

        <form [formGroup]="editForm" (ngSubmit)="onSave()">
          <div class="form-group">
            <label for="nome">Nome Completo *</label>
            <input
              id="nome"
              type="text"
              formControlName="nome"
              class="form-control"
              [class.is-invalid]="editForm.get('nome')?.invalid && editForm.get('nome')?.touched"
            />
            @if (editForm.get('nome')?.invalid && editForm.get('nome')?.touched) {
              <small class="error-text">Nome é obrigatório</small>
            }
          </div>

          <div class="form-group">
            <label for="email">Email *</label>
            <input
              id="email"
              type="email"
              formControlName="email"
              class="form-control"
              [class.is-invalid]="editForm.get('email')?.invalid && editForm.get('email')?.touched"
            />
            @if (editForm.get('email')?.invalid && editForm.get('email')?.touched) {
              <small class="error-text">Email é obrigatório e deve ser válido</small>
            }
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="telefone">Telefone</label>
              <input
                id="telefone"
                type="text"
                formControlName="telefone"
                class="form-control"
                mask="(00) 90000-0000"
              />
            </div>

            <div class="form-group">
              <label for="comercial">Telefone Comercial</label>
              <input
                id="comercial"
                type="text"
                formControlName="comercial"
                class="form-control"
                mask="(00) 90000-0000"
              />
            </div>

            <div class="form-group">
              <label for="celular">Celular</label>
              <input
                id="celular"
                type="text"
                formControlName="celular"
                class="form-control"
                mask="(00) 00000-0000"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="cep">CEP</label>
              <input
                id="cep"
                type="text"
                formControlName="cep"
                class="form-control"
                mask="00000-000"
              />
            </div>

            <div class="form-group">
              <label for="estado">Estado</label>
              <input
                id="estado"
                type="text"
                formControlName="estado"
                class="form-control"
                maxlength="2"
                placeholder="UF"
              />
            </div>

            <div class="form-group">
              <label for="cidade">Cidade</label>
              <input
                id="cidade"
                type="text"
                formControlName="cidade"
                class="form-control"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="logradouro">Logradouro</label>
              <input
                id="logradouro"
                type="text"
                formControlName="logradouro"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="numero">Número</label>
              <input
                id="numero"
                type="text"
                formControlName="numero"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="complemento">Complemento</label>
              <input
                id="complemento"
                type="text"
                formControlName="complemento"
                class="form-control"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="bairro">Bairro</label>
            <input
              id="bairro"
              type="text"
              formControlName="bairro"
              class="form-control"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="nascimento">Data de Nascimento</label>
              <input
                id="nascimento"
                type="date"
                formControlName="nascimento"
                class="form-control"
              />
            </div>

            <div class="form-group">
              <label for="estadoCivil">Estado Civil</label>
              <select
                id="estadoCivil"
                formControlName="estadoCivil"
                class="form-control"
                [disabled]="hasConjugueTelefone"
              >
                <option [value]="false">Solteiro</option>
                <option [value]="true">Casado</option>
              </select>
              @if (hasConjugueTelefone) {
                <small class="form-text text-muted">
                  O estado civil não pode ser alterado após informar o telefone do cônjuge.
                </small>
              }
            </div>
          </div>

          @if (editForm.get('estadoCivil')?.value || hasConjugueTelefone) {
            <div class="form-group">
              <label for="conjugueTelefone">Telefone do Cônjuge</label>
              <input
                id="conjugueTelefone"
                type="text"
                formControlName="conjugueTelefone"
                class="form-control"
                placeholder="(00) 00000-0000"
                mask="(00) 00000-0000"
                [dropSpecialCharacters]="false"
                [disabled]="hasConjugueTelefone"
              />
              @if (hasConjugueTelefone) {
                <small class="form-text text-muted">
                  O telefone do cônjuge não pode ser alterado após ser informado.
                </small>
              }
              @if (editForm.get('conjugueTelefone')?.invalid && editForm.get('conjugueTelefone')?.touched && !hasConjugueTelefone) {
                <small class="error-text">
                  @if (editForm.get('conjugueTelefone')?.hasError('invalidTelefone')) {
                    Telefone inválido. Deve conter 10 ou 11 dígitos.
                  }
                </small>
              }
            </div>
          }

          @if (availableGroups.length > 0 && !foundMember.child) {
            <div class="form-group">
              <label>Grupos de Voluntariado</label>
              <div class="groups-checkbox-list">
                @for (group of availableGroups; track group.id) {
                  <div class="checkbox-item">
                    @if (isGroupApproved(group.id!)) {
                      <input
                        type="checkbox"
                        [id]="'group-' + group.id"
                        [checked]="true"
                        [disabled]="true"
                      />
                      <label [for]="'group-' + group.id" class="group-approved">
                        {{ group.nome }}
                        @if (group.descricao) {
                          <small class="text-muted"> - {{ group.descricao }}</small>
                        }
                        <small class="status-text">✓ Você faz parte deste grupo</small>
                      </label>
                    } @else if (isGroupPending(group.id!)) {
                      <input
                        type="checkbox"
                        [id]="'group-' + group.id"
                        [checked]="true"
                        [disabled]="true"
                      />
                      <label [for]="'group-' + group.id" class="group-pending">
                        {{ group.nome }}
                        @if (group.descricao) {
                          <small class="text-muted"> - {{ group.descricao }}</small>
                        }
                        <small class="status-text">⏳ Solicitação aguardando aprovação</small>
                      </label>
                    } @else if (isGroupRejected(group.id!) && !canRequestGroup(group.id!)) {
                      <input
                        type="checkbox"
                        [id]="'group-' + group.id"
                        [checked]="false"
                        [disabled]="true"
                      />
                      <label [for]="'group-' + group.id" class="group-rejected">
                        {{ group.nome }}
                        @if (group.descricao) {
                          <small class="text-muted"> - {{ group.descricao }}</small>
                        }
                        <small class="status-text">✗ Solicitação rejeitada. Você poderá solicitar novamente a partir de {{ getRejectionDate(group.id!) }}</small>
                        @if (getRejectionReason(group.id!)) {
                          <small class="rejection-reason">Motivo: {{ getRejectionReason(group.id!) }}</small>
                        }
                      </label>
                    } @else {
                      <input
                        type="checkbox"
                        [id]="'group-' + group.id"
                        [checked]="false"
                        (change)="toggleGroup(group.id!)"
                        [disabled]="isLoading"
                      />
                      <label [for]="'group-' + group.id">
                        {{ group.nome }}
                        @if (group.descricao) {
                          <small class="text-muted"> - {{ group.descricao }}</small>
                        }
                      </label>
                    }
                  </div>
                }
              </div>
              <small class="form-text text-muted">
                Selecione os grupos de voluntariado aos quais você deseja se inscrever.
              </small>
            </div>
          }

          <div class="form-actions">
            <button
              type="button"
              class="btn-secondary"
              (click)="backToSearch()"
              [disabled]="isLoading"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="btn-primary"
              [disabled]="editForm.invalid || isLoading"
            >
              @if (isLoading) {
                Salvando...
              } @else {
                Atualizar Cadastro
              }
            </button>
          </div>
        </form>
      </div>
    }
  </div>
</div>
