<div class="public-update-container">
  <div class="public-update-card">
    <div class="header">
      <h1>Adicionar Visitante</h1>
      <p class="subtitle">Preencha os dados do visitante</p>
      <div class="header-actions">
        <button type="button" class="btn-link" (click)="goToLanding()">
          ← Voltar
        </button>
      </div>
    </div>

    <div class="form-section">
      <form [formGroup]="visitorForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="nomeCompleto">Nome Completo *</label>
          <input
            id="nomeCompleto"
            type="text"
            formControlName="nomeCompleto"
            class="form-control"
            placeholder="Digite o nome completo"
          />
          @if (visitorForm.get('nomeCompleto')?.invalid && visitorForm.get('nomeCompleto')?.touched) {
            <small class="error-text">Nome completo é obrigatório</small>
          }
        </div>

        <div class="form-group">
          <label for="dataVisita">Data de Hoje *</label>
          <input
            id="dataVisita"
            type="date"
            formControlName="dataVisita"
            class="form-control"
          />
          @if (visitorForm.get('dataVisita')?.invalid && visitorForm.get('dataVisita')?.touched) {
            <small class="error-text">Data é obrigatória</small>
          }
        </div>

        <div class="form-group">
          <label for="telefone">Número (Telefone, WhatsApp)</label>
          <input
            id="telefone"
            type="text"
            formControlName="telefone"
            class="form-control"
            placeholder="(00) 00000-0000"
            [mask]="'(00) 00000-0000'"
            [dropSpecialCharacters]="false"
          />
        </div>

        <div class="form-group">
          <label for="jaFrequentaIgreja">Já Frequenta Igreja?</label>
          <select
            id="jaFrequentaIgreja"
            formControlName="jaFrequentaIgreja"
            class="form-control"
          >
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>

        @if (jaFrequentaIgreja === 'Sim') {
          <div class="form-group">
            <label for="nomeIgreja">Nome da Igreja *</label>
            <input
              id="nomeIgreja"
              type="text"
              formControlName="nomeIgreja"
              class="form-control"
              placeholder="Digite o nome da igreja"
            />
            @if (visitorForm.get('nomeIgreja')?.invalid && visitorForm.get('nomeIgreja')?.touched) {
              <small class="error-text">Nome da igreja é obrigatório</small>
            }
          </div>
        }

        <div class="form-group">
          <label for="procuraIgreja">Está à Procura de uma Igreja?</label>
          <select
            id="procuraIgreja"
            formControlName="procuraIgreja"
            class="form-control"
          >
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>

        <div class="form-group">
          <label for="eDeSP">É de SP?</label>
          <select
            id="eDeSP"
            formControlName="eDeSP"
            class="form-control"
          >
            <option [value]="true">Sim</option>
            <option [value]="false">Não</option>
          </select>
        </div>

        @if (!eDeSP) {
          <div class="form-group">
            <label for="estado">Estado *</label>
            <select
              id="estado"
              formControlName="estado"
              class="form-control"
            >
              <option value="">Selecione o estado</option>
              @for (estado of estadosBR; track estado) {
                <option [value]="estado">{{ estado }}</option>
              }
            </select>
            @if (visitorForm.get('estado')?.invalid && visitorForm.get('estado')?.touched) {
              <small class="error-text">Estado é obrigatório quando não é de SP</small>
            }
          </div>
        }

        <div class="form-group">
          <label class="switch-label">
            <input type="checkbox" [formControl]="isAccompaniedControl">
            <span>Está acompanhado?</span>
          </label>
        </div>

        @if (isAccompaniedControl.value) {
          <div class="accompanying-section">
            <h3>Acompanhantes</h3>
            
            <div formArrayName="accompanyingVisitors">
              @for (item of accompanyingControls; track $index) {
                <div [formGroupName]="$index" class="accompanying-visitor-card">
                  <div class="accompanying-header">
                    <h4>Acompanhante {{ $index + 1 }}</h4>
                    <button type="button" (click)="removeAccompanying($index)" class="btn-icon-danger" title="Remover">
                      Remover
                    </button>
                  </div>

                  <div class="form-group">
                    <label class="switch-label">
                      <input type="checkbox" formControlName="copyFromHost">
                      <span>Copiar dados do anfitrião</span>
                    </label>
                  </div>

                  <div class="form-group">
                    <label>Nome Completo *</label>
                    <input formControlName="nomeCompleto" type="text" class="form-control" 
                           [disabled]="isLoading">
                    @if (item.get('nomeCompleto')?.invalid && item.get('nomeCompleto')?.touched) {
                      <small class="error-text">Nome é obrigatório</small>
                    }
                  </div>

                  <div class="form-group">
                    <label>Vínculo *</label>
                    <select formControlName="relationship" class="form-control" 
                            [disabled]="isLoading">
                      <option value="">Selecione</option>
                      <option value="Amigo(a)">Amigo(a)</option>
                      <option value="Filho(a)">Filho(a)</option>
                      <option value="Esposo(a)">Esposo(a)</option>
                      <option value="Irmão(ã)">Irmão(ã)</option>
                      <option value="Vizinho(a)">Vizinho(a)</option>
                      <option value="Conhecido(a)">Conhecido(a)</option>
                      <option value="Parente">Parente</option>
                      <option value="Familiar">Familiar</option>
                      <option value="Outro">Outro</option>
                    </select>
                    @if (item.get('relationship')?.invalid && item.get('relationship')?.touched) {
                      <small class="error-text">Vínculo é obrigatório</small>
                    }
                  </div>

                  <div class="form-group">
                    <label>Número (Telefone, WhatsApp)</label>
                    <input
                      formControlName="telefone"
                      type="text"
                      class="form-control"
                      placeholder="(00) 00000-0000"
                      [mask]="'(00) 00000-0000'"
                      [dropSpecialCharacters]="false"
                      [disabled]="item.get('copyFromHost')?.value || isLoading"
                    />
                  </div>

                  <div class="form-group">
                    <label>Já Frequenta Igreja?</label>
                    <select
                      formControlName="jaFrequentaIgreja"
                      class="form-control"
                      [disabled]="item.get('copyFromHost')?.value || isLoading"
                    >
                      <option value="">Selecione</option>
                      <option value="Sim">Sim</option>
                      <option value="Não">Não</option>
                    </select>
                  </div>

                  @if (getAccompanyingJaFrequentaIgreja($index) === 'Sim') {
                    <div class="form-group">
                      <label>Nome da Igreja</label>
                      <input
                        formControlName="nomeIgreja"
                        type="text"
                        class="form-control"
                        placeholder="Digite o nome da igreja"
                        [disabled]="item.get('copyFromHost')?.value || isLoading"
                      />
                      @if (item.get('nomeIgreja')?.invalid && item.get('nomeIgreja')?.touched) {
                        <small class="error-text">Nome da igreja é obrigatório quando frequenta igreja</small>
                      }
                    </div>
                  }

                  <div class="form-group">
                    <label>Está à Procura de uma Igreja?</label>
                    <select
                      formControlName="procuraIgreja"
                      class="form-control"
                      [disabled]="item.get('copyFromHost')?.value || isLoading"
                    >
                      <option value="">Selecione</option>
                      <option value="Sim">Sim</option>
                      <option value="Não">Não</option>
                    </select>
                  </div>

                  <div class="form-group">
                    <label>É de SP?</label>
                    <select
                      formControlName="eDeSP"
                      class="form-control"
                      [disabled]="item.get('copyFromHost')?.value || isLoading"
                    >
                      <option [value]="true">Sim</option>
                      <option [value]="false">Não</option>
                    </select>
                  </div>

                  @if (!getAccompanyingEDeSP($index)) {
                    <div class="form-group">
                      <label>Estado</label>
                      <select
                        formControlName="estado"
                        class="form-control"
                        [disabled]="item.get('copyFromHost')?.value || isLoading"
                      >
                        <option value="">Selecione o estado</option>
                        @for (estado of estadosBR; track estado) {
                          <option [value]="estado">{{ estado }}</option>
                        }
                      </select>
                      @if (item.get('estado')?.invalid && item.get('estado')?.touched) {
                        <small class="error-text">Estado é obrigatório quando não é de SP</small>
                      }
                    </div>
                  }
                </div>
              }
            </div>

            <button type="button" (click)="addAccompanying()" class="btn-secondary btn-sm" [disabled]="isLoading">
              + Adicionar Pessoa
            </button>
          </div>
        }

        <button
          type="submit"
          class="btn-primary"
          [disabled]="visitorForm.invalid || visitorForm.disabled"
        >
          @if (isLoading) {
            Enviando...
          } @else {
            Enviar
          }
        </button>
      </form>
    </div>
  </div>
</div>

