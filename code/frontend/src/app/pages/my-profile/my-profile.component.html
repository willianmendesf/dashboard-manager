<div class="page-container">
  <pagetitle
    title="Meu Perfil"
    subtitle="Gerencie suas informações pessoais"
  ></pagetitle>

  <div *ngIf="loading" class="loading-message">
    <p>Carregando perfil...</p>
  </div>

  <div *ngIf="!loading && currentUser" class="profile-content">
    <!-- Mensagens de Sucesso/Erro -->
    <div *ngIf="successMessage" class="alert alert-success">
      {{ successMessage }}
    </div>
    <div *ngIf="error" class="alert alert-error">
      {{ error }}
    </div>

    <!-- Seção de Foto de Perfil -->
    <div class="profile-photo-section">
      <div class="photo-container">
        <img 
          [src]="profilePhotoUrl" 
          [alt]="currentUser.name"
          class="profile-avatar"
          (error)="onImageError($event)"
        />
        <div class="photo-actions">
          <label for="photo-upload" class="btn-secondary">
            <input 
              type="file" 
              id="photo-upload" 
              accept="image/jpeg,image/png,image/gif"
              (change)="onPhotoSelected($event)"
              [disabled]="uploadingPhoto"
              style="display: none;"
            />
            {{ uploadingPhoto ? 'Enviando...' : 'Alterar Foto' }}
          </label>
          <button 
            type="button" 
            class="btn-secondary btn-danger"
            (click)="removePhoto()"
            [disabled]="!currentUser.fotoUrl"
          >
            Remover Foto
          </button>
        </div>
      </div>
    </div>

    <!-- Formulário de Dados Pessoais -->
    <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="profile-form">
      <div class="form-section">
        <h3>Dados Pessoais</h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Nome Completo <span class="required">*</span></label>
            <input 
              type="text" 
              id="name"
              formControlName="name"
              class="form-control"
              [class.invalid]="profileForm.get('name')?.invalid && profileForm.get('name')?.touched"
            />
            <div *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched" class="error-message">
              Nome é obrigatório e deve ter pelo menos 3 caracteres
            </div>
          </div>

          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input 
              type="tel" 
              id="telefone"
              formControlName="telefone"
              class="form-control"
              placeholder="(00) 00000-0000"
            />
          </div>

          <div class="form-group">
            <label>Email</label>
            <input 
              type="email" 
              [value]="currentUser.email"
              class="form-control"
              disabled
            />
            <small class="field-hint">O email não pode ser alterado</small>
          </div>

          <div class="form-group">
            <label>CPF</label>
            <input 
              type="text" 
              [value]="formatCPF(currentUser.cpf || '')"
              class="form-control"
              disabled
            />
            <small class="field-hint">O CPF não pode ser alterado</small>
          </div>

          <div class="form-group">
            <label>Cargo/Perfil</label>
            <input 
              type="text" 
              [value]="currentUser.profileName"
              class="form-control"
              disabled
            />
            <small class="field-hint">O perfil não pode ser alterado aqui</small>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button 
          type="submit" 
          class="btn-primary"
          [disabled]="saving || profileForm.invalid"
        >
          {{ saving ? 'Salvando...' : 'Salvar Alterações' }}
        </button>
        <button 
          type="button" 
          class="btn-secondary"
          (click)="openPasswordModal()"
        >
          Alterar Senha
        </button>
      </div>
    </form>
  </div>

  <!-- Modal de Alteração de Senha -->
  <app-modal
    *ngIf="showPasswordModal"
    [title]="'Alterar Senha'"
    [footerButtons]="getPasswordModalButtons()"
    (close)="closePasswordModal()"
  >
    <form [formGroup]="passwordForm" (ngSubmit)="changePassword()">
      <div class="form-group">
        <label for="senhaAtual">Senha Atual <span class="required">*</span></label>
        <input 
          type="password" 
          id="senhaAtual"
          formControlName="senhaAtual"
          class="form-control"
          [class.invalid]="passwordForm.get('senhaAtual')?.invalid && passwordForm.get('senhaAtual')?.touched"
        />
        <div *ngIf="passwordForm.get('senhaAtual')?.invalid && passwordForm.get('senhaAtual')?.touched" class="error-message">
          Senha atual é obrigatória
        </div>
      </div>

      <div class="form-group">
        <label for="novaSenha">Nova Senha <span class="required">*</span></label>
        <input 
          type="password" 
          id="novaSenha"
          formControlName="novaSenha"
          class="form-control"
          [class.invalid]="passwordForm.get('novaSenha')?.invalid && passwordForm.get('novaSenha')?.touched"
        />
        <div *ngIf="passwordForm.get('novaSenha')?.invalid && passwordForm.get('novaSenha')?.touched" class="error-message">
          Nova senha deve ter pelo menos 6 caracteres
        </div>
      </div>

      <div class="form-group">
        <label for="confirmarNovaSenha">Confirmar Nova Senha <span class="required">*</span></label>
        <input 
          type="password" 
          id="confirmarNovaSenha"
          formControlName="confirmarNovaSenha"
          class="form-control"
          [class.invalid]="passwordForm.get('confirmarNovaSenha')?.invalid && passwordForm.get('confirmarNovaSenha')?.touched"
        />
        <div *ngIf="passwordForm.get('confirmarNovaSenha')?.errors?.['passwordMismatch'] && passwordForm.get('confirmarNovaSenha')?.touched" class="error-message">
          As senhas não coincidem
        </div>
      </div>
    </form>
  </app-modal>
</div>

