<div class="page-container">
  <pagetitle
    title="Gerenciamento de Usu√°rios"
    subtitle="Crie, edite e gerencie usu√°rios do sistema"
  ></pagetitle>

  <div class="actions-bar">
    <div class="search-filters">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="filterUsers()"
          placeholder="Buscar usu√°rios..."
        />
        <div class="search-icon">üîç</div>
      </div>
      <select [(ngModel)]="statusFilter" (change)="filterUsers()" class="filter-select">
        <option value="">Todos os Status</option>
        <option value="active">Ativos</option>
        <option value="inactive">Inativos</option>
      </select>
      <select [(ngModel)]="roleFilter" (change)="filterUsers()" class="filter-select">
        <option value="">Todas as Fun√ß√µes</option>
        <option value="admin">Administrador</option>
        <option value="manager">Gerente</option>
        <option value="user">Usu√°rio</option>
      </select>
    </div>
    <button class="btn-secondary" (click)="getUsers()">Atualizar</button>
    <button class="btn-primary" (click)="openUserModal()">+ Novo Usu√°rio</button>
  </div>

  <div class="users-table-container">
    <table class="users-table">
      <thead>
        <tr>
          <th>Usu√°rio</th>
          <th>Nome</th>
          <th>Email</th>
          <!-- <th>Telefone</th> -->
          <th>Fun√ß√£o</th>
          <th>Status</th>
          <!-- <th>√öltimo Acesso</th> -->
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of filteredUsers" class="user-row">
          <td class="user-cell">
            <div class="user-avatar">{{ user.name.charAt(0) }}</div>
            <div class="user-info">
              <div class="user-name">{{ user.username }}</div>
              <div class="user-id">ID: {{ user.id }}</div>
            </div>
          </td>
          <td>
            <div class="user-name">{{ user.name }}</div>
          </td>
          <td>{{ user.email }}</td>
          <!-- <td>{{ user.phone }}</td> -->
          <td>
            <span class="role-badge" [class]="user.role">
              {{ getRoleText(user.role) }}
            </span>
          </td>
          <td>
            <span class="status-badge">
              {{ user.status === 'active' ? 'Ativo' : 'Inativo' }}
            </span>
          </td>
          <!-- <td>{{ user.lastLogin || 'Nunca' }}</td> -->
          <td>
            <div class="action-buttons">
              <button class="btn-action view" (click)="viewUser(user)" title="Visualizar">
                üëÅÔ∏è
              </button>
            @if (user.role !== 'root') {
                <button class="btn-action edit" (click)="editUser(user)" title="Editar">
                  ‚úèÔ∏è
                </button>
                <button class="btn-action delete" (click)="deleteUser(user)" title="Excluir">
                  üóëÔ∏è
                </button>
              }
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="empty-state" *ngIf="filteredUsers.length === 0">
      <div class="empty-icon">üë§</div>
      <h3>Nenhum usu√°rio encontrado</h3>
      <p>Tente ajustar os filtros ou criar um novo usu√°rio</p>
    </div>
  </div>

  <div class="pagination">
    <button class="btn-pagination" [disabled]="currentPage === 1" (click)="previousPage()">
      ‚Üê Anterior
    </button>
    <span class="pagination-info">
      P√°gina {{ currentPage }} de {{ totalPages }}
    </span>
    <button class="btn-pagination" [disabled]="currentPage === totalPages" (click)="nextPage()">
      Pr√≥xima ‚Üí
    </button>
  </div>

  <!-- Edit/Create User Modal -->
  <app-modal
    [title]="isEditing ? 'Editar Usu√°rio' : 'Novo Usu√°rio'"
    [isOpen]="showUserModal"
    [size]="'large'"
    [footerButtons]="getEditModalButtons()"
    (close)="closeUserModal()">
    
    <form (ngSubmit)="saveUser()">
      <div class="form-section">
        <h4 class="section-title">Informa√ß√µes B√°sicas</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Nome Completo *</label>
            <input
              type="text"
              [(ngModel)]="currentUser.name"
              name="name"
              class="form-control"
              required
            />
          </div>

          <div class="form-group">
            <label>Usu√°rio</label>
            <input
              type="tel"
              [(ngModel)]="currentUser.username"
              name="username"
              class="form-control"
              placeholder=""
              required
            />
          </div>

          <div class="form-group">
            <label>Fun√ß√£o *</label>
            <select [(ngModel)]="currentUser.role" name="role" class="form-control" required>
              <option value="">Selecione uma fun√ß√£o</option>
              <!-- <option value="root">Root</option> -->
              <option value="admin">Administrador</option>
              <option value="manager">Gerente</option>
              <option value="user">Usu√°rio</option>
            </select>
          </div>

          <div class="form-group">
            <label>Status</label>
            <select [(ngModel)]="currentUser.status" name="status" class="form-control">
              <option value="active">Ativo</option>
              <option value="inactive">Inativo</option>
            </select>
          </div>


          <div class="form-group" *ngIf="!isEditing">
            <label>Email *</label>
            <input
              type="email"
              [(ngModel)]="currentUser.email"
              name="email"
              class="form-control"
              required
            />
          </div>
          <div class="form-group" *ngIf="isEditing">
            <label>Email *</label>
            <input
              disabled
              type="email"
              [(ngModel)]="currentUser.email"
              name="email"
              class="form-control"
              required
            />
          </div>

          <div class="form-group" *ngIf="!isEditing">
            <label>Senha *</label>
            <input
              type="password"
              [(ngModel)]="currentUser.password"
              name="password"
              class="form-control"
              placeholder="Senha ser√° enviada por email"
            />
          </div>
        </div>

      </div>

      @if (currentUser.role) {
        <div class="form-section">
          <h4 class="section-title">Permiss√µes</h4>
          <div class="permissions-grid">
            @for (permission of getPermissionsForRole(currentUser.role); track permission) {
              <label class="permission-item">
                <input type="checkbox" [checked]="true" disabled />
                <span>{{ permission }}</span>
              </label>
            }
          </div>
        </div>
      }
    </form>
  </app-modal>

  <!-- View User Modal -->
  <app-modal
    [title]="'Detalhes do Usu√°rio'"
    [isOpen]="showViewModal"
    [size]="'medium'"
    [footerButtons]="getViewModalButtons()"
    (close)="closeViewModal()">
    
    @if (viewingUser) {
      <div class="detail-section">
        <h4 class="section-title">Informa√ß√µes B√°sicas</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>Nome Completo</label>
            <span>{{ viewingUser.name || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Usu√°rio</label>
            <span>{{ viewingUser.username || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Email</label>
            <span>{{ viewingUser.email || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Fun√ß√£o</label>
            <span class="badge" [class.active]="viewingUser.role">{{ getRoleText(viewingUser.role) }}</span>
          </div>
          <div class="detail-item">
            <label>Status</label>
            <span class="badge" [class.active]="viewingUser.status === 'active'" [class.inactive]="viewingUser.status === 'inactive'">
              {{ viewingUser.status === 'active' ? 'Ativo' : 'Inativo' }}
            </span>
          </div>
        </div>
      </div>

      @if (viewingUser.role) {
        <div class="detail-section">
          <h4 class="section-title">Permiss√µes</h4>
          <div class="tags-list">
            @for (permission of getPermissionsForRole(viewingUser.role); track permission) {
              <span class="tag">{{ permission }}</span>
            }
          </div>
        </div>
      }
    }
  </app-modal>
</div>
