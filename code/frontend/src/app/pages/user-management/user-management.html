<div class="page-container">
  <pagetitle
    title="Gerenciamento de Usuários"
    subtitle="Crie, edite e gerencie usuários do sistema"
  ></pagetitle>

  <div class="actions-bar">
    <div class="search-filters">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="filterUsers()"
          placeholder="Buscar usuários..."
        />
        <div class="search-icon" [innerHTML]="getSearchIcon()" [attr.aria-hidden]="true"></div>
      </div>
      <select [(ngModel)]="statusFilter" (change)="filterUsers()" class="filter-select">
        <option value="">Todos os Status</option>
        <option value="active">Ativos</option>
        <option value="inactive">Inativos</option>
      </select>
      <select [(ngModel)]="roleFilter" (change)="filterUsers()" class="filter-select">
        <option value="">Todas as Funções</option>
        <option value="admin">Administrador</option>
        <option value="manager">Gerente</option>
        <option value="user">Usuário</option>
      </select>
    </div>
    <button class="btn-secondary" (click)="getUsers()">Atualizar</button>
    <button class="btn-primary" (click)="openUserModal()">+ Novo Usuário</button>
  </div>

  <app-data-table
    [columns]="tableColumns"
    [data]="tableData"
    [actions]="getTableActions()"
    [loading]="false"
    emptyMessage="Nenhum usuário encontrado"
    [striped]="true"
    [hoverable]="true"
    [enablePagination]="true"
    (sortChange)="onSortChange($event)"
  >
    <ng-template #rowTemplate let-row let-column="column">
      @if (column.key === 'status') {
        <span class="badge" [class]="row.status === 'Ativo' ? 'active' : 'inactive'">{{ getStatusLabel(row.status === 'Ativo' ? 'active' : 'inactive') }}</span>
      } @else if (column.key === 'telefone') {
        <div class="phone-cell">
          <span>{{ row[column.key] || '-' }}</span>
          @if (row[column.key] && row[column.key] !== '-' && utilsService.getWhatsAppLink(row[column.key])) {
            <a 
              [href]="utilsService.getWhatsAppLink(row[column.key])" 
              target="_blank" 
              class="whatsapp-icon-button"
              title="Abrir no WhatsApp"
              (click)="$event.stopPropagation()"
              [innerHTML]="getWhatsAppIcon()"
            ></a>
          }
        </div>
      } @else {
        {{ row[column.key] || '-' }}
      }
    </ng-template>
  </app-data-table>

  <!-- Edit/Create User Modal -->
  <app-modal
    [title]="isEditing ? 'Editar Usuário' : 'Novo Usuário'"
    [isOpen]="showUserModal"
    [size]="'large'"
    [footerButtons]="getEditModalButtons()"
    (close)="closeUserModal()">
    
    <form (ngSubmit)="saveUser()">
      <div class="form-section">
        <h4 class="section-title">Informações Básicas</h4>
        
        <!-- Foto de Perfil -->
        <div class="form-group photo-upload-group">
          <label>Foto de Perfil</label>
          <div class="photo-upload-container">
            <div class="photo-preview">
              <img 
                [src]="photoPreview || 'img/avatar-default.png'"
                alt="Foto do perfil"
                class="avatar-preview"
                onerror="this.src='img/avatar-default.png'"
              />
            </div>
            <div class="photo-upload-controls">
              <input
                type="file"
                id="userPhotoInput"
                accept="image/*"
                (change)="onPhotoSelected($event)"
                class="photo-input"
              />
              <label for="userPhotoInput" class="btn-photo-upload">
                {{ photoPreview ? 'Alterar Foto' : 'Selecionar Foto' }}
              </label>
              @if (selectedPhotoFile) {
                <span class="photo-file-name">{{ selectedPhotoFile.name }}</span>
              }
            </div>
          </div>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label>Nome Completo *</label>
            <input
              type="text"
              [(ngModel)]="currentUser.name"
              name="name"
              class="form-control"
              required
            />
          </div>

          <div class="form-group">
            <label>Usuário</label>
            <input
              type="text"
              [(ngModel)]="currentUser.username"
              name="username"
              class="form-control"
              placeholder=""
              [disabled]="isEditingSelf"
              required
            />
            @if (isEditingSelf) {
              <small class="form-text text-muted">
                Seu nome de usuário não pode ser alterado.
              </small>
            }
          </div>

          <div class="form-group">
            <label>Função *</label>
            <select
              [(ngModel)]="currentUser.role" 
              name="role" 
              class="form-control" 
              [disabled]="isEditingSelf || isTargetRoot"
              required>
              <option value="">Selecione uma função</option>
              <!-- <option value="root">Root</option> -->
              <option value="admin">Administrador</option>
              <option value="manager">Gerente</option>
              <option value="user">Usuário</option>
            </select>
            @if (isEditingSelf) {
              <small class="form-text text-muted">
                Você não pode alterar sua própria função.
              </small>
            }
            @if (isTargetRoot && !isEditingSelf) {
              <small class="form-text text-muted">
                A função de um usuário Root não pode ser alterada.
              </small>
            }
          </div>

          <div class="form-group">
            <label>Status</label>
            <select 
              [(ngModel)]="currentUser.status" 
              name="status" 
              class="form-control"
              [disabled]="isEditingSelf">
              <option value="active">Ativo</option>
              <option value="inactive">Inativo</option>
            </select>
            @if (isEditingSelf) {
              <small class="form-text text-muted">
                Você não pode desativar sua própria conta.
              </small>
            }
          </div>


          <div class="form-group" *ngIf="!isEditing">
            <label>Email *</label>
            <input
              type="email"
              [(ngModel)]="currentUser.email"
              name="email"
              class="form-control"
              required
            />
          </div>
          <div class="form-group" *ngIf="isEditing">
            <label>Email *</label>
            <input
              disabled
              type="email"
              [(ngModel)]="currentUser.email"
              name="email"
              class="form-control"
              required
            />
          </div>

          <div class="form-group">
            <label>CPF *</label>
            <input
              type="text"
              [(ngModel)]="currentUser.cpf"
              name="cpf"
              class="form-control"
              placeholder="000.000.000-00"
              mask="000.000.000-00"
              [disabled]="isCpfDisabled"
              required
            />
            @if (isCpfDisabled) {
              <small class="form-text text-muted">
                Seu CPF não pode ser alterado após preenchido.
              </small>
            }
          </div>

          <div class="form-group">
            <label>Telefone *</label>
            <input
              type="tel"
              [(ngModel)]="currentUser.telefone"
              name="telefone"
              class="form-control"
              placeholder="(00) 00000-0000"
              mask="(00) 00000-0000"
              [disabled]="isTelefoneDisabled"
              required
            />
            @if (isTelefoneDisabled) {
              <small class="form-text text-muted">
                Seu Telefone não pode ser alterado após preenchido.
              </small>
            }
          </div>

          <div class="form-group" *ngIf="!isEditing">
            <label>Senha *</label>
            <input
              type="password"
              [(ngModel)]="currentUser.password"
              name="password"
              class="form-control"
              placeholder="Senha será enviada por email"
            />
          </div>
        </div>

      </div>

      @if (isEditing) {
        <div class="form-section">
          <h4 class="section-title">Alterar Senha</h4>
          <div class="form-grid">
            <div class="form-group">
              <label for="novaSenha">Nova Senha</label>
              <input
                id="novaSenha"
                type="password"
                [(ngModel)]="currentUser.novaSenha"
                name="novaSenha"
                class="form-control"
                placeholder="Deixe em branco para não alterar"
              />
            </div>

            <div class="form-group">
              <label for="confirmarSenha">Confirmar Nova Senha</label>
              <input
                id="confirmarSenha"
                type="password"
                [(ngModel)]="currentUser.confirmarSenha"
                name="confirmarSenha"
                class="form-control"
                placeholder="Confirme a nova senha"
              />
            </div>
          </div>
        </div>
      }

      @if (currentUser.role) {
        <div class="form-section">
          <h4 class="section-title">Permissões</h4>
          <div class="permissions-grid">
            @for (permission of getPermissionsForRole(currentUser.role); track permission) {
              <label class="permission-item">
                <input type="checkbox" [checked]="true" disabled />
                <span>{{ permission }}</span>
              </label>
            }
          </div>
        </div>
      }
    </form>
  </app-modal>

  <!-- View User Modal -->
  <app-modal
    [title]="'Detalhes do Usuário'"
    [isOpen]="showViewModal"
    [size]="'medium'"
    [footerButtons]="getViewModalButtons()"
    (close)="closeViewModal()">
    
    @if (viewingUser) {
      <div class="visualizar-header">
        <img 
          [src]="viewingUser.fotoUrl || 'img/avatar-default.png'"
          alt="Foto do usuário"
          class="visualizar-avatar"
          onerror="this.src='img/avatar-default.png'"
        />
        <h2>{{ viewingUser.name || 'Usuário' }}</h2>
      </div>
      
      <div class="detail-section">
        <h4 class="section-title">Informações Básicas</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>Nome Completo</label>
            <span>{{ viewingUser.name || 'Não informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Usuário</label>
            <span>{{ viewingUser.username || 'Não informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Email</label>
            <span>{{ viewingUser.email || 'Não informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Função</label>
            <span class="badge" [class.active]="viewingUser.role">{{ getRoleText(viewingUser.role) }}</span>
          </div>
          <div class="detail-item">
            <label>Telefone</label>
            <div class="phone-display">
              @if (viewingUser.telefone && utilsService.getWhatsAppLink(viewingUser.telefone)) {
                <a 
                  [href]="utilsService.getWhatsAppLink(viewingUser.telefone)" 
                  target="_blank" 
                  class="whatsapp-icon-button"
                  title="Abrir no WhatsApp"
                  [innerHTML]="getWhatsAppIcon()"
                ></a>
              }
              <span>{{ viewingUser.telefone || 'Não informado' }}</span>
            </div>
          </div>
          <div class="detail-item">
            <label>Status</label>
            <span class="badge" [class.active]="viewingUser.status === 'active'" [class.inactive]="viewingUser.status === 'inactive'">
              {{ viewingUser.status === 'active' ? 'Ativo' : 'Inativo' }}
            </span>
          </div>
        </div>
      </div>

      @if (viewingUser.role) {
        <div class="detail-section">
          <h4 class="section-title">Permissões</h4>
          <div class="tags-list">
            @for (permission of getPermissionsForRole(viewingUser.role); track permission) {
              <span class="tag">{{ permission }}</span>
            }
          </div>
        </div>
      }
    }
  </app-modal>
</div>
