<div class="page-container">
  <pagetitle
    title="Gerenciar Membros"
    subtitle="Gerenciamento de membros da IPBF"
  ></pagetitle>

  <div class="actions-bar">
    <div class="search-filters">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="filterMembers()"
          placeholder="Buscar membros..."
        />
        <div class="search-icon" [innerHTML]="getSearchIcon()" [attr.aria-hidden]="true"></div>
      </div>
      <select [(ngModel)]="tipoCadastroFilter" (change)="filterMembers()" class="filter-select">
        <option value="">Todos os Tipos</option>
        <option value="Membro">Membro</option>
        <option value="Visitante">Visitante</option>
        <option value="Seminarista">Seminarista</option>
        <option value="Presb√≠tero">Presb√≠tero</option>
        <option value="Pastor">Pastor</option>
        <option value="Pastor Auxiliar">Pastor Auxiliar</option>
        <option value="Ex-Membro">Ex-Membro</option>
        <option value="Excomungado">Excomungado</option>
      </select>
      <select [(ngModel)]="estadoCivilFilter" (change)="filterMembers()" class="filter-select">
        <option value="">Todos os Estados Civis</option>
        <option value="Solteiro">Solteiro</option>
        <option value="Casado">Casado</option>
      </select>
      <select [(ngModel)]="intercessorFilter" (change)="filterMembers()" class="filter-select">
        <option value="">Todos os Intercessores</option>
        <option value="Sim">Sim</option>
        <option value="N√£o">N√£o</option>
      </select>
      <select [ngModel]="groupFilter" (ngModelChange)="onGroupFilterChange($event)" class="filter-select">
        <option [ngValue]="null">Todos os Grupos</option>
        @for (group of availableGroups; track group.id) {
          <option [ngValue]="group.id">{{ group.nome }}</option>
        }
      </select>
    </div>
  </div>
  <div class="action-buttons">
    <button class="btn-secondary" (click)="getMembers()" type="button">Atualizar</button>
    <button class="btn-secondary" (click)="openImportModal()" type="button">
      <span class="btn-icon" [innerHTML]="getImportIcon()" [attr.aria-hidden]="true"></span>
      Importar Planilha
    </button>
    <button class="btn-primary" (click)="openMemberModal()" type="button">+ Novo Membro</button>
  </div>

  <app-data-table
    [columns]="tableColumns"
    [data]="tableData"
    [actions]="getTableActions()"
    [loading]="false"
    emptyMessage="Nenhum membro encontrado"
    [striped]="true"
    [hoverable]="true"
    [enablePagination]="true"
    (sortChange)="onSortChange($event)"
  >
    <ng-template #rowTemplate let-row let-column="column">
      @if (column.key === 'whatsapp') {
        <div class="whatsapp-cell">
          @if (row.whatsapp && row.whatsapp !== '-' && row.whatsapp !== null && row.whatsapp !== '' && utilsService.getWhatsAppLink(row.whatsapp)) {
            <a 
              [href]="utilsService.getWhatsAppLink(row.whatsapp)" 
              target="_blank" 
              class="whatsapp-icon-button"
              title="Abrir no WhatsApp"
              (click)="$event.stopPropagation()"
              [innerHTML]="getWhatsAppIcon()"
            ></a>
          } @else {
            <span class="no-whatsapp">-</span>
          }
        </div>
      } @else if (column.key === 'intercessor') {
        <span class="badge" [class.active]="row.intercessor === 'Sim'" [class.inactive]="row.intercessor === 'N√£o'">
          {{ row[column.key] || '-' }}
        </span>
      } @else {
        {{ row[column.key] || '-' }}
      }
    </ng-template>
  </app-data-table>

  <!-- Edit/Create Member Modal -->
  <app-modal
    [title]="isEditing ? 'Editar Membro' : 'Novo Membro'"
    [isOpen]="showMemberModal"
    [size]="'xlarge'"
    [footerButtons]="getEditModalButtons()"
    (close)="closeMemberModal()">
    
    <form (ngSubmit)="saveMember()">
      <div class="form-section">
        <h4 class="section-title">Informa√ß√µes B√°sicas</h4>
        
        <!-- Foto de Perfil -->
        <div class="form-group photo-upload-group">
          <label>Foto de Perfil</label>
          <div class="photo-upload-container">
            <div class="photo-preview">
              <img 
                [src]="photoPreview || 'img/avatar-default.png'"
                alt="Foto do perfil"
                class="avatar-preview"
                onerror="this.src='img/avatar-default.png'"
              />
            </div>
            <div class="photo-upload-controls">
              <input
                type="file"
                id="memberPhotoInput"
                accept="image/*"
                (change)="onPhotoSelected($event)"
                class="photo-input"
              />
              <label for="memberPhotoInput" class="btn-photo-upload">
                {{ photoPreview ? 'Alterar Foto' : 'Selecionar Foto' }}
              </label>
              @if (selectedPhotoFile) {
                <span class="photo-file-name">{{ selectedPhotoFile.name }}</span>
              }
            </div>
          </div>
        </div>
        
        <div class="form-grid">

          <div class="form-group">
            <label>Nome Completo *</label>
            <input
              type="text"
              [(ngModel)]="currentMember.nome"
              name="nome"
              class="form-control"
              required
            />
          </div>

          <div class="form-group">
            <label>Data de Nascimento</label>
            <input
              type="date"
              [(ngModel)]="currentMember.nascimento"
              name="nascimento"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>Estado Civil <span class="required">*</span></label>
            <select
              [(ngModel)]="currentMember.estadoCivil"
              name="estadoCivil"
              class="form-control"
              required
            >
              <option [value]="false">Solteiro</option>
              <option [value]="true">Casado</option>
            </select>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4 class="section-title">Documentos</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>CPF</label>
            <input
              type="text"
              [(ngModel)]="currentMember.cpf"
              name="cpf"
              class="form-control"
              mask="000.000.000-00"
              placeholder="000.000.000-00"
            />
          </div>

          <div class="form-group">
            <label>RG</label>
            <input
              type="text"
              [(ngModel)]="currentMember.rg"
              name="rg"
              class="form-control"
              mask="00.000.000-0"
              placeholder="00.000.000-0"
            />
          </div>

          @if (currentMember.estadoCivil) {
            <div class="form-group">
              <label>CPF do C√¥njuge</label>
              <input
                type="text"
                [(ngModel)]="currentMember.conjugueCPF"
                name="conjugueCPF"
                class="form-control"
                mask="000.000.000-00"
                placeholder="000.000.000-00"
              />
            </div>
          }
          
          @if (currentMember.estadoCivil && isValidCpf(currentMember.conjugueCPF)) {
            <div class="form-group" style="grid-column: 1 / -1;">
              <app-spouse-preview [cpf]="currentMember.conjugueCPF"></app-spouse-preview>
            </div>
          }
        </div>
      </div>

      <div class="form-section">
        <h4 class="section-title">Contatos</h4>
        <div class="form-grid">

          <div class="form-group">
            <label>Telefone</label>
            <input
              type="text"
              [(ngModel)]="currentMember.telefone"
              name="telefone"
              class="form-control"
              mask="(00) 00000-0000"
              placeholder="(00) 0000-0000"
            />
          </div>

          <div class="form-group">
            <label>Celular</label>
            <input
              type="text"
              [(ngModel)]="currentMember.celular"
              name="celular"
              class="form-control"
              mask="(00) 00000-0000"
              placeholder="(00) 00000-0000"
            />
          </div>

          <div class="form-group">
            <label>Comercial</label>
            <input
              type="text"
              [(ngModel)]="currentMember.comercial"
              name="comercial"
              class="form-control"
              mask="(00) 00000-0000"
              placeholder="(00) 0000-0000"
            />
          </div>

          <div class="form-group">
            <label>Email <span class="required">*</span></label>
            <input
              type="email"
              [(ngModel)]="currentMember.email"
              name="email"
              class="form-control"
              required
              placeholder="email@gmail.com"
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4 class="section-title">Endere√ßo</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>CEP</label>
            <input
              type="text"
              [(ngModel)]="currentMember.cep"
              name="cep"
              class="form-control"
              mask="00000-000"
              placeholder="00000-000"
              (blur)="lookupCep(currentMember.cep)"
            />
          </div>

          <div class="form-group">
            <label>Logradouro</label>
            <input
              type="text"
              [(ngModel)]="currentMember.logradouro"
              name="logradouro"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>N√∫mero</label>
            <input
              type="text"
              [(ngModel)]="currentMember.numero"
              name="numero"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>Complemento</label>
            <input
              type="text"
              [(ngModel)]="currentMember.complemento"
              name="complemento"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>Bairro</label>
            <input
              type="text"
              [(ngModel)]="currentMember.bairro"
              name="bairro"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>Cidade</label>
            <input
              type="text"
              [(ngModel)]="currentMember.cidade"
              name="cidade"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label>Estado</label>
            <input
              type="text"
              [(ngModel)]="currentMember.estado"
              name="estado"
              class="form-control"
            />
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4 class="section-title">Configura√ß√µes</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Tipo de Cadastro</label>
            <select
              [(ngModel)]="currentMember.tipoCadastro"
              name="tipoCadastro"
              class="form-control"
            >
              <option [value]="'Membro'">Membro</option>
              <option [value]="'Visitante'">Visitante</option>
              <option [value]="'Seminarista'">Seminarista</option>
              <option [value]="'Presb√≠tero'">Presb√≠tero</option>
              <option [value]="'Pastor'">Pastor</option>
              <option [value]="'Pastor Auxiliar'">Pastor Auxiliar</option>
              <option [value]="'Ex-Membro'">Ex-Membro</option>
              <option [value]="'Excomungado'">Excomungado</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Comungante</label>
            <select
              [(ngModel)]="currentMember.comungante"
              name="comungante"
              class="form-control"
            >
              <option [value]="true">Sim</option>
              <option [value]="false">N√£o</option>
            </select>
          </div>

          <div class="form-group">
            <label>Intercessor</label>
            <select
              [(ngModel)]="currentMember.intercessor"
              name="intercessor"
              class="form-control"
            >
              <option [value]="true">Sim</option>
              <option [value]="false">N√£o</option>
            </select>
          </div>

          <div class="form-group">
            <label>Crian√ßa?</label>
            <select
              [(ngModel)]="currentMember.child"
              name="child"
              class="form-control"
            >
              <option [value]="false">N√£o</option>
              <option [value]="true">Sim</option>
            </select>
          </div>

          <div class="form-group">
            <label>LGPD Aceito?</label>
            <select
              [(ngModel)]="currentMember.lgpd"
              name="lgpd"
              class="form-control"
            >
              <option [value]="true">Sim</option>
              <option [value]="false">N√£o</option>
            </select>
          </div>

          @if (currentMember.lgpd === true) {
            <div class="form-group">
              <label>LGPD Aceito em *</label>
              <input
                type="date"
                [(ngModel)]="currentMember.lgpdAceitoEm"
                name="lgpdAceitoEm"
                class="form-control"
                required
              />
            </div>
          }
        </div>
      </div>

      @if (availableGroups.length > 0) {
        <div class="form-section">
          <h4 class="section-title">Grupos de Voluntariado</h4>
          <div class="groups-checkbox-list">
            @for (group of availableGroups; track group.id) {
              <div class="checkbox-item">
                @if (currentMember.id) {
                  @if (getMemberPendingGroups(currentMember.id).includes(group.id!)) {
                    <input
                      type="checkbox"
                      [id]="'group-' + group.id"
                      [checked]="true"
                      [disabled]="true"
                    />
                    <label [for]="'group-' + group.id" class="group-pending-info">
                      {{ group.nome }}
                      @if (group.descricao) {
                        <small class="text-muted"> - {{ group.descricao }}</small>
                      }
                      <small class="status-badge">‚è≥ Solicita√ß√£o pendente</small>
                    </label>
                  } @else {
                    <input
                      type="checkbox"
                      [id]="'group-' + group.id"
                      [checked]="isGroupSelected(group.id!)"
                      (change)="toggleGroup(group.id!)"
                    />
                    <label [for]="'group-' + group.id">
                      {{ group.nome }}
                      @if (group.descricao) {
                        <small class="text-muted"> - {{ group.descricao }}</small>
                      }
                    </label>
                  }
                } @else {
                  <input
                    type="checkbox"
                    [id]="'group-' + group.id"
                    [checked]="isGroupSelected(group.id!)"
                    (change)="toggleGroup(group.id!)"
                  />
                  <label [for]="'group-' + group.id">
                    {{ group.nome }}
                    @if (group.descricao) {
                      <small class="text-muted"> - {{ group.descricao }}</small>
                    }
                  </label>
                }
              </div>
            }
          </div>
          <small class="form-text text-muted">
            Selecione os grupos de voluntariado aos quais o membro pertence.
          </small>
        </div>
      }
    </form>
  </app-modal>

  <!-- View Member Modal -->
  <app-modal
    [title]="'Detalhes do Membro'"
    [isOpen]="showViewModal"
    [size]="'large'"
    [footerButtons]="getViewModalButtons()"
    (close)="closeViewModal()">
    
    @if (viewingMember) {
      <div class="visualizar-header">
        <img 
          [src]="getNormalizedPhotoUrl(viewingMember.fotoUrl)"
          alt="Foto do membro"
          class="visualizar-avatar"
          onerror="this.src='img/avatar-default.png'"
        />
        <h2>{{ viewingMember.nome || 'Membro' }}</h2>
      </div>
      
      <div class="detail-section">
        <h4 class="section-title">Informa√ß√µes B√°sicas</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>Nome Completo</label>
            <span>{{ viewingMember.nome || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Data de Nascimento</label>
            <span>{{ viewingMember.nascimento ? (viewingMember.nascimento | date:'dd/MM/yyyy') : 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Estado Civil</label>
            <span class="badge" [class.active]="viewingMember.estadoCivil">
              {{ viewingMember.estadoCivil ? 'Casado' : 'Solteiro' }}
            </span>
          </div>
          <div class="detail-item">
            <label>Tipo de Cadastro</label>
            <span>{{ viewingMember.tipoCadastro || 'N√£o informado' }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4 class="section-title">Documentos</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>CPF</label>
            <span>{{ viewingMember.cpf || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>RG</label>
            <span>{{ viewingMember.rg || 'N√£o informado' }}</span>
          </div>
          @if (viewingMember.conjugueCPF) {
            <div class="detail-item">
              <label>CPF do C√¥njuge</label>
              <span>{{ viewingMember.conjugueCPF }}</span>
            </div>
            @if (isValidCpf(viewingMember.conjugueCPF)) {
              <div class="detail-item" style="grid-column: 1 / -1;">
                <label>Informa√ß√µes do C√¥njuge</label>
                <app-spouse-preview [cpf]="viewingMember.conjugueCPF"></app-spouse-preview>
              </div>
            }
          }
        </div>
      </div>

      <div class="detail-section">
        <h4 class="section-title">Contatos</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>Email</label>
            <span>{{ viewingMember.email || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Telefone</label>
            <div class="phone-display">
              @if (viewingMember.telefone && utilsService.getWhatsAppLink(viewingMember.telefone)) {
                <a 
                  [href]="utilsService.getWhatsAppLink(viewingMember.telefone)" 
                  target="_blank" 
                  class="whatsapp-icon-button"
                  title="Abrir no WhatsApp"
                  [innerHTML]="getWhatsAppIcon()"
                ></a>
              }
              <span>{{ viewingMember.telefone || 'N√£o informado' }}</span>
            </div>
          </div>
          <div class="detail-item">
            <label>Celular</label>
            <div class="phone-display">
              @if (viewingMember.celular && utilsService.getWhatsAppLink(viewingMember.celular)) {
                <a 
                  [href]="utilsService.getWhatsAppLink(viewingMember.celular)" 
                  target="_blank" 
                  class="whatsapp-icon-button"
                  title="Abrir no WhatsApp"
                  [innerHTML]="getWhatsAppIcon()"
                ></a>
              }
              <span>{{ viewingMember.celular || 'N√£o informado' }}</span>
            </div>
          </div>
          <div class="detail-item">
            <label>Comercial</label>
            <span>{{ viewingMember.comercial || 'N√£o informado' }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4 class="section-title">Endere√ßo</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>CEP</label>
            <span>{{ viewingMember.cep || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Logradouro</label>
            <span>{{ viewingMember.logradouro || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>N√∫mero</label>
            <span>{{ viewingMember.numero || 'N√£o informado' }}</span>
          </div>
          @if (viewingMember.complemento) {
            <div class="detail-item">
              <label>Complemento</label>
              <span>{{ viewingMember.complemento }}</span>
            </div>
          }
          <div class="detail-item">
            <label>Bairro</label>
            <span>{{ viewingMember.bairro || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Cidade</label>
            <span>{{ viewingMember.cidade || 'N√£o informado' }}</span>
          </div>
          <div class="detail-item">
            <label>Estado</label>
            <span>{{ viewingMember.estado || 'N√£o informado' }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4 class="section-title">Configura√ß√µes</h4>
        <div class="details-grid">
          <div class="detail-item">
            <label>Comungante</label>
            <span class="badge" [class.active]="viewingMember.comungante" [class.inactive]="!viewingMember.comungante">
              {{ viewingMember.comungante ? 'Sim' : 'N√£o' }}
            </span>
          </div>
          <div class="detail-item">
            <label>Intercessor</label>
            <span class="badge" [class.active]="viewingMember.intercessor" [class.inactive]="!viewingMember.intercessor">
              {{ viewingMember.intercessor ? 'Sim' : 'N√£o' }}
            </span>
          </div>
          <div class="detail-item">
            <label>Crian√ßa?</label>
            <span class="badge" [class.active]="viewingMember.child" [class.inactive]="!viewingMember.child">
              {{ viewingMember.child ? 'Sim' : 'N√£o' }}
            </span>
          </div>
          <div class="detail-item">
            <label>LGPD Aceito</label>
            <span class="badge" [class.active]="viewingMember.lgpd" [class.inactive]="!viewingMember.lgpd">
              {{ viewingMember.lgpd ? 'Sim' : 'N√£o' }}
            </span>
          </div>
          @if (viewingMember.lgpdAceitoEm) {
            <div class="detail-item">
              <label>LGPD Aceito Em</label>
              <span>{{ viewingMember.lgpdAceitoEm | date:'dd/MM/yyyy' }}</span>
            </div>
          }
        </div>
      </div>

      @if (viewingMember.id && memberEnrollments.get(viewingMember.id)) {
        @if (getMemberApprovedGroups(viewingMember.id).length > 0) {
          <div class="detail-section">
            <h4 class="section-title">Grupos de Voluntariado</h4>
            <div class="groups-list">
              @for (enrollment of memberEnrollments.get(viewingMember.id)!; track enrollment.id) {
                @if (enrollment.status === 'APPROVED') {
                  <div class="group-badge">
                    <span>{{ enrollment.groupName }}</span>
                    @for (group of availableGroups; track group.id) {
                      @if (group.id === enrollment.groupId && group.descricao) {
                        <small class="text-muted"> - {{ group.descricao }}</small>
                      }
                    }
                  </div>
                }
              }
            </div>
          </div>
        }
      }
    }
  </app-modal>

  <!-- Import Members Modal -->
  <app-modal
    [title]="'Importar Membros'"
    [isOpen]="showImportModal"
    [size]="'medium'"
    [footerButtons]="getImportModalButtons()"
    (close)="closeImportModal()">
    
    <div class="import-container">
      <div class="import-info">
        <p>Fa√ßa o upload de um arquivo Excel (.xlsx) ou CSV para importar membros em lote.</p>
        <p class="text-muted">O arquivo deve seguir o formato do modelo dispon√≠vel abaixo.</p>
      </div>

      <div class="import-actions">
        <button type="button" class="btn-secondary" (click)="downloadTemplate()">
          üì• Baixar Modelo de Planilha
        </button>
      </div>

      <div 
        class="import-dropzone"
        [class.drag-over]="false"
        (dragover)="onImportDragOver($event)"
        (drop)="onImportFileDropped($event)"
      >
        <div class="dropzone-content">
          <div class="dropzone-icon">üì§</div>
          <p class="dropzone-text">
            {{ selectedImportFile ? selectedImportFile.name : 'Arraste e solte o arquivo aqui' }}
          </p>
          <p class="dropzone-hint">ou</p>
          <label for="importFileInput" class="btn-primary">
            Selecionar Arquivo
          </label>
          <input
            type="file"
            id="importFileInput"
            accept=".xlsx,.xls,.csv"
            (change)="onImportFileSelected($event)"
            style="display: none;"
          />
          <p class="dropzone-formats">Formatos aceitos: .xlsx, .xls, .csv</p>
        </div>
      </div>

      @if (importProgress) {
        <div class="import-progress">
          <p [innerHTML]="formatImportProgress(importProgress)"></p>
        </div>
      }

      @if (importResult && importResult.errors && importResult.errors.length > 0) {
        <div class="import-errors">
          <h5>Erros encontrados:</h5>
          <ul>
            @for (error of importResult.errors; track $index) {
              <li>{{ error }}</li>
            }
          </ul>
        </div>
      }
    </div>
  </app-modal>
</div>
