<div class="page-container">
  <pagetitle
    title="Meu Perfil"
    subtitle="Gerencie suas informações pessoais"
  ></pagetitle>

  <ng-container *ngIf="profileData$ | async as currentUser; else loading">
  <div class="profile-content">
    <!-- Mensagens de Sucesso/Erro -->
    <div *ngIf="successMessage" class="alert alert-success">
      {{ successMessage }}
    </div>
    <div *ngIf="error" class="alert alert-error">
      {{ error }}
    </div>

    <!-- Seção de Foto de Perfil -->
    <div class="profile-photo-section">
      <div class="photo-container">
        <img 
          [src]="getProfilePhotoUrl(currentUser)" 
          [alt]="currentUser.name"
          class="profile-avatar"
          (error)="onImageError($event)"
        />
        <div class="photo-actions">
          <label for="photo-upload" class="btn-secondary">
            <input 
              type="file" 
              id="photo-upload" 
              accept="image/jpeg,image/png,image/gif"
              (change)="onPhotoSelected($event)"
              [disabled]="uploadingPhoto"
              style="display: none;"
            />
            {{ uploadingPhoto ? 'Enviando...' : 'Alterar Foto' }}
          </label>
          <button 
            type="button" 
            class="btn-secondary btn-danger"
            (click)="removePhoto()"
            [disabled]="!currentUser.fotoUrl"
          >
            Remover Foto
          </button>
        </div>
      </div>
    </div>

    <!-- Formulário de Dados Pessoais -->
    <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="profile-form">
      <div class="form-section">
        <h3>Dados Pessoais</h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="name">Nome Completo <span class="required">*</span></label>
            <input 
              type="text" 
              id="name"
              formControlName="name"
              class="form-control"
              [class.invalid]="profileForm.get('name')?.invalid && profileForm.get('name')?.touched"
            />
            <div *ngIf="profileForm.get('name')?.invalid && profileForm.get('name')?.touched" class="error-message">
              Nome é obrigatório e deve ter pelo menos 3 caracteres
            </div>
          </div>

          <div class="form-group">
            <label for="telefone">Telefone</label>
            <input 
              type="tel" 
              id="telefone"
              formControlName="telefone"
              class="form-control"
              placeholder="(00) 00000-0000"
              mask="(00) 90000-0000"
              [disabled]="!!currentUser.telefone"
            />
            <small *ngIf="currentUser.telefone" class="field-hint">O telefone não pode ser alterado após o cadastro</small>
          </div>

          <div class="form-group">
            <label>Email</label>
            <input 
              type="email" 
              [value]="currentUser.email"
              class="form-control"
              disabled
            />
            <small class="field-hint">O email não pode ser alterado</small>
          </div>

          <div class="form-group">
            <label>Cargo/Perfil</label>
            <input 
              type="text" 
              [value]="currentUser.profileName"
              class="form-control"
              disabled
            />
            <small class="field-hint">O perfil não pode ser alterado aqui</small>
          </div>
        </div>
      </div>

      <!-- Seção de Alteração de Senha -->
      <div class="form-section">
        <h3>Alterar Senha</h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="senhaAtual">Senha Atual</label>
            <input 
              type="password" 
              id="senhaAtual"
              formControlName="senhaAtual"
              class="form-control"
              [class.invalid]="profileForm.get('senhaAtual')?.invalid && profileForm.get('senhaAtual')?.touched"
              placeholder="Deixe em branco para não alterar"
            />
            <div *ngIf="profileForm.get('senhaAtual')?.hasError('passwordRequired') && profileForm.get('senhaAtual')?.touched" class="error-message">
              Senha atual é obrigatória para alterar a senha
            </div>
          </div>

          <div class="form-group">
            <label for="novaSenha">Nova Senha</label>
            <input 
              type="password" 
              id="novaSenha"
              formControlName="novaSenha"
              class="form-control"
              [class.invalid]="profileForm.get('novaSenha')?.invalid && profileForm.get('novaSenha')?.touched"
              placeholder="Mínimo 6 caracteres"
            />
            <div *ngIf="profileForm.get('novaSenha')?.touched" class="error-message">
              <div *ngIf="profileForm.get('novaSenha')?.hasError('passwordRequired')">
                Nova senha é obrigatória para alterar a senha
              </div>
              <div *ngIf="profileForm.get('novaSenha')?.hasError('minlength') && !profileForm.get('novaSenha')?.hasError('passwordRequired')">
                Nova senha deve ter pelo menos 6 caracteres
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="confirmarNovaSenha">Confirmar Nova Senha</label>
            <input 
              type="password" 
              id="confirmarNovaSenha"
              formControlName="confirmarNovaSenha"
              class="form-control"
              [class.invalid]="profileForm.get('confirmarNovaSenha')?.invalid && profileForm.get('confirmarNovaSenha')?.touched"
              placeholder="Repita a nova senha"
            />
            <div *ngIf="profileForm.get('confirmarNovaSenha')?.touched" class="error-message">
              <div *ngIf="profileForm.get('confirmarNovaSenha')?.hasError('passwordRequired')">
                Confirmação de senha é obrigatória para alterar a senha
              </div>
              <div *ngIf="profileForm.get('confirmarNovaSenha')?.errors?.['passwordMismatch'] && !profileForm.get('confirmarNovaSenha')?.hasError('passwordRequired')">
                As senhas não coincidem
              </div>
            </div>
          </div>
        </div>
        <small class="field-hint">Deixe os campos de senha em branco se não desejar alterar sua senha.</small>
      </div>

      <div class="form-actions">
        <button 
          type="submit" 
          class="btn-primary"
          [disabled]="saving || profileForm.invalid"
        >
          {{ saving ? 'Salvando...' : 'Salvar Alterações' }}
        </button>
      </div>
    </form>
  </div>
  </ng-container>
  
  <ng-template #loading>
    <div class="loading-message">
      <p>Carregando perfil...</p>
    </div>
  </ng-template>

</div>

