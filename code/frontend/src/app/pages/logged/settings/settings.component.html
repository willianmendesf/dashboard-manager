<div class="page-container">
  <pagetitle
    title="Configurações"
    subtitle="Gerencie as configurações globais do sistema"
  ></pagetitle>

  <div class="actions-bar">
    <button 
      type="button" 
      class="btn-secondary" 
      (click)="cancelChanges()"
      [disabled]="saving"
    >
      Cancelar
    </button>
    <button 
      type="button" 
      class="btn-primary" 
      (click)="saveSettings()"
      [disabled]="saving || settingsForm.invalid"
    >
      <span *ngIf="!saving">Salvar Alterações</span>
      <span *ngIf="saving">Salvando...</span>
    </button>
  </div>

  <ng-container *ngIf="configurations$ | async as configurations; else loading">
  <form [formGroup]="settingsForm">
    <div class="settings-layout">
      <!-- Lado Esquerdo: Sistema em 3 colunas -->
      <div class="settings-left">
        <!-- Seção Sistema -->
        <div class="settings-section system-section">
          <h2>Sistema</h2>
          <div class="system-grid">
            <!-- Coluna 1: Gerenciamento de Jobs -->
            <div class="system-column">
              <h3>Gerenciamento de Jobs</h3>
              
              <div class="setting-item">
                <label>Recorrência - Relatórios Semanais</label>
                <cron-selector [(currentAppointment)]="jobWeeklyReports" [uniqueId]="'weekly-reports'"></cron-selector>
              </div>

              <div class="setting-item">
                <label>Recorrência - Sincronização de Dados</label>
                <cron-selector [(currentAppointment)]="jobDataSync" [uniqueId]="'data-sync'"></cron-selector>
              </div>

              <div class="setting-item">
                <label>Recorrência - Carregamento de Agendamentos</label>
                <cron-selector [(currentAppointment)]="jobLoadAppointments" [uniqueId]="'load-appointments'"></cron-selector>
              </div>
            </div>

            <!-- Coluna 2: Configurações de API e Outras Configurações -->
            <div class="system-column">
              <h3>Configurações de API</h3>
              
              <div class="setting-item">
                <label>Chave API - Serviço Externo 1</label>
                <input 
                  type="password" 
                  formControlName="apiKeyExternalService1"
                  placeholder="Digite a chave de API"
                  autocomplete="off"
                />
                <small class="field-hint">Chave de API para serviços externos (tipo senha)</small>
              </div>

              <div class="setting-item">
                <label>Chave API - Serviço Externo 2</label>
                <input 
                  type="password" 
                  formControlName="apiKeyExternalService2"
                  placeholder="Digite a chave de API"
                  autocomplete="off"
                />
                <small class="field-hint">Chave de API para serviços externos (tipo senha)</small>
              </div>

              <div class="setting-item">
                <label>URL da API WhatsApp</label>
                <input 
                  type="text" 
                  formControlName="whatsappApiUrl"
                  placeholder="https://api-whatsapp.exemplo.com"
                  autocomplete="off"
                />
                <small class="field-hint">
                  URL da API externa do WhatsApp Web. 
                  Se não configurado, será usado o valor do arquivo .env como fallback.
                </small>
              </div>

              <div class="setting-item section-divider">
                <h3 class="section-subtitle">Outras Configurações</h3>
              </div>
              
              <div class="setting-item">
                <label>Backup Automático</label>
                <select>
                  <option>Diário</option>
                  <option>Semanal</option>
                  <option>Mensal</option>
                  <option>Desabilitado</option>
                </select>
              </div>
              
              <div class="setting-item">
                <label>Retenção de Logs</label>
                <select>
                  <option>30 dias</option>
                  <option>90 dias</option>
                  <option>1 ano</option>
                </select>
              </div>
              
              <div class="setting-toggle">
                <label>
                  <input type="checkbox" checked />
                  <span class="toggle-slider"></span>
                  Coleta de dados de uso
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Lado Direito: Aparência e Notificações -->
      <div class="settings-right">
        <!-- Seção Aparência -->
        <div class="settings-section">
          <h2>Aparência</h2>
        <div class="setting-group">
          <!-- Upload de Logo -->
          <div class="setting-item">
            <label>Logo da Empresa</label>
            <app-logo-upload
              [currentLogoUrl]="logoUrl"
              (logoUploaded)="onLogoUploaded($event)"
              (logoRemoved)="onLogoRemoved()"
            ></app-logo-upload>
          </div>

          <!-- Upload de Favicon -->
          <div class="setting-item">
            <label>Favicon do Site</label>
            <app-favicon-upload
              [currentFaviconUrl]="faviconUrl"
              (faviconUploaded)="onFaviconUploaded($event)"
              (faviconRemoved)="onFaviconRemoved()"
            ></app-favicon-upload>
          </div>

          <!-- Cor Primária -->
          <div class="setting-item">
            <label>Cor Primária</label>
            <div class="color-input-wrapper">
              <input 
                type="color" 
                formControlName="primaryColor" 
                class="color-picker"
              />
              <input 
                type="text" 
                formControlName="primaryColor" 
                placeholder="#3B82F6"
                class="color-text-input"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
            </div>
          </div>

          <!-- Cor Secundária -->
          <div class="setting-item">
            <label>Cor Secundária</label>
            <div class="color-input-wrapper">
              <input 
                type="color" 
                formControlName="secondaryColor" 
                class="color-picker"
              />
              <input 
                type="text" 
                formControlName="secondaryColor" 
                placeholder="#10B981"
                class="color-text-input"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
            </div>
          </div>

          <!-- Cor Fundo Menu Lateral -->
          <div class="setting-item">
            <label>Cor Fundo Menu Lateral</label>
            <div class="color-input-wrapper">
              <input 
                type="color" 
                formControlName="menuBackgroundColor" 
                class="color-picker"
              />
              <input 
                type="text" 
                formControlName="menuBackgroundColor" 
                placeholder="#1F2937"
                class="color-text-input"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
            </div>
          </div>

          <!-- Cor Texto/Ícones Menu -->
          <div class="setting-item">
            <label>Cor Texto/Ícones Menu</label>
            <div class="color-input-wrapper">
              <input 
                type="color" 
                formControlName="menuTextColor" 
                class="color-picker"
              />
              <input 
                type="text" 
                formControlName="menuTextColor" 
                placeholder="#FFFFFF"
                class="color-text-input"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
            </div>
          </div>
        </div>
      </div>

        <!-- Seção Notificações -->
        <div class="settings-section">
          <h2>Notificações</h2>
          <div class="setting-group">
            <div class="setting-toggle">
              <label>
                <input 
                  type="checkbox" 
                  formControlName="notificationsEmail"
                />
                <span class="toggle-slider"></span>
                Notificações por email
              </label>
            </div>
            <div class="setting-toggle">
              <label>
                <input 
                  type="checkbox" 
                  formControlName="notificationsPush"
                />
                <span class="toggle-slider"></span>
                Notificações push
              </label>
            </div>
            
            <!-- Toggle WhatsApp -->
            <div class="setting-toggle">
              <label>
                <input 
                  type="checkbox" 
                  formControlName="notificationsWhatsApp"
                />
                <span class="toggle-slider"></span>
                Notificações por WhatsApp
              </label>
            </div>

            <!-- Sub-seleções WhatsApp -->
            <div *ngIf="isWhatsAppEnabled" class="whatsapp-sub-options">
              <div class="setting-toggle whatsapp-option">
                <label>
                  <input 
                    type="checkbox" 
                    formControlName="whatsAppWeeklyReports"
                  />
                  <span class="toggle-slider"></span>
                  Relatórios semanais
                </label>
              </div>
              <div class="setting-toggle whatsapp-option">
                <label>
                  <input 
                    type="checkbox" 
                    formControlName="whatsAppSecurityAlerts"
                  />
                  <span class="toggle-slider"></span>
                  Alertas de segurança
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </form>
  </ng-container>
  
  <ng-template #loading>
    <div class="loading-message">
      <p>Carregando configurações...</p>
    </div>
  </ng-template>
</div>
