<div class="page-container">
  <pagetitle
    title="WhatsApp Business"
    subtitle="Envio de mensagens para grupos e pessoas via whatsapp"
  ></pagetitle>

  <!-- Status de Conex√£o -->
  <div class="connection-status-card" *ngIf="connectionStatus">
    <div class="status-content">
      <div class="status-indicator">
        <span class="status-badge" [class.connected]="connectionStatus.is_connected" [class.disconnected]="!connectionStatus.is_connected">
          <span class="status-dot"></span>
          {{ connectionStatus.is_connected ? 'Conectado √† API' : 'Desconectado da API' }}
        </span>
        <span class="status-details" *ngIf="connectionStatus.is_logged_in">
          ‚Ä¢ Logado com n√∫mero
        </span>
        <span class="status-details" *ngIf="connectionStatus.device_id">
          ‚Ä¢ {{ connectionStatus.device_id }}
        </span>
      </div>
      <div class="status-actions">
        <button 
          class="btn-reconnect" 
          *ngIf="shouldShowReconnectButton()"
          (click)="manualReconnect()" 
          [disabled]="isReconnecting"
          [class.loading]="isReconnecting"
        >
          {{ isReconnecting ? 'Reconectando...' : 'Reconectar Agora' }}
        </button>
        <button 
          class="btn-login" 
          *ngIf="shouldShowLoginButton()"
          (click)="openLoginModal()"
        >
          Fazer Login
        </button>
        <button 
          class="btn-logout" 
          *ngIf="connectionStatus?.is_logged_in"
          (click)="logout()"
        >
          Logout
        </button>
        <label class="toggle-auto-reconnect" *ngIf="connectionStatus?.is_logged_in">
          <input 
            type="checkbox" 
            [checked]="isAutoReconnectEnabled" 
            (change)="toggleAutoReconnect()"
          />
          <span>Reconex√£o Autom√°tica</span>
          <small *ngIf="isAutoReconnectEnabled">(a cada {{ autoReconnectIntervalMinutes }} min)</small>
        </label>
      </div>
    </div>
    <div class="status-footer">
      <small>√öltima verifica√ß√£o: {{ formatLastCheck() }}</small>
      <small *ngIf="connectionStatus.error" class="error-text">Erro: {{ connectionStatus.error }}</small>
    </div>
  </div>

  <div class="whatsapp-layout">
    <!-- √Årea de mensagens - S√≥ exibe quando conectado e logado -->
    <ng-container *ngIf="canSendMessages(); else disconnectedMessage">
      <!-- Sidebar com contatos e grupos -->
      <div class="contacts-sidebar">
      <div class="sidebar-header">
        <div class="search-box">
          <input
            type="text"
            [(ngModel)]="searchTerm"
            (input)="filter()"
            placeholder="Buscar contatos..."
          />
          <span class="search-icon" [innerHTML]="getSearchIcon()" [attr.aria-hidden]="true"></span>
        </div>
        <div class="filter-tabs">
          <button class="tab-button"
            [class.active]="activeTab === 'contacts'"
            (click)="activeTab = 'contacts'; filter()"
          >Contatos</button>
          <button class="tab-button"
            [class.active]="activeTab === 'groups'"
            (click)="activeTab = 'groups'; filter()"
          >Grupos</button>
        </div>
      </div>

      <div class="contacts-list">
        <!-- Lista de Contatos -->
        <div *ngIf="activeTab === 'contacts'">
          <div
            class="contact-item" *ngFor="let contact of filteredContacts"
            [class.selected]="selectedRecipient?.type === 'contact' && selectedRecipient?.id === contact.id"
            (click)="selectContact(contact)"
          >
            <div class="contact-avatar">
              {{ contact.name.charAt(0) }}
              <div class="online-indicator" *ngIf="contact.isOnline"></div>
            </div>
            <div class="contact-info">
              <div class="contact-name">{{ contact.name }}</div>
              <div class="contact-phone">{{ contact.phone }}</div>
              <div class="contact-status" *ngIf="contact.lastSeen">
                {{ contact.isOnline ? 'Online' : contact.lastSeen }}
              </div>
            </div>
          </div>
        </div>

        <!-- Lista de Grupos -->
        <div *ngIf="activeTab === 'groups'">
          <div
            class="contact-item group-item" *ngFor="let group of filteredGroups"
            [class.selected]="selectedRecipient?.type === 'group' && selectedRecipient?.id === group.id"
            (click)="selectGroup(group)"
          >
            <div class="contact-avatar group-avatar">
              <span [innerHTML]="getUsersIcon()" [attr.aria-hidden]="true"></span>
            </div>
            <div class="contact-info">
              <div class="contact-name">{{ group.name }}</div>
              <div class="group-description">{{ group.id }}</div>
            </div>
          </div>
        </div>

        <div class="empty-state" *ngIf="getFilteredItems().length === 0">
          <div class="empty-icon" [innerHTML]="getPhoneIcon()" [attr.aria-hidden]="true"></div>
          <p>Nenhum {{ activeTab === 'contacts' ? 'contato' : 'grupo' }} encontrado</p>
        </div>
      </div>
    </div>

    <!-- √Årea de composi√ß√£o de mensagem -->
    <div class="message-composer">
      <div class="composer-header" *ngIf="selectedRecipient">
        <div class="recipient-info">
          <div class="recipient-avatar">
            <span *ngIf="selectedRecipient.type === 'group'" [innerHTML]="getUsersIcon()" [attr.aria-hidden]="true"></span>
            <span *ngIf="selectedRecipient.type !== 'group'">{{ selectedRecipient.name.charAt(0) }}</span>
          </div>
          <div class="recipient-details">
            <h3>{{ selectedRecipient.name }}</h3>
            <p *ngIf="selectedRecipient.type === 'contact'">
              {{ selectedRecipient.phone }}
              <span class="online-status" *ngIf="selectedRecipient.isOnline">‚Ä¢ Online</span>
            </p>
            <!-- <p *ngIf="selectedRecipient.type === 'group'">
              {{ selectedRecipient.members.length }} membros
            </p> -->
          </div>
        </div>
        <div class="header-actions">
          <button class="btn-action" (click)="showRecipientInfo = true" title="Informa√ß√µes">
            ‚ÑπÔ∏è
          </button>
        </div>
      </div>

      <div class="composer-body" *ngIf="selectedRecipient">
        <!-- <div class="message-history">
          <div
            class="message-bubble"
            *ngFor="let message of getMessagesForRecipient()"
            [class.sent]="true"
          >
            <div class="message-content">{{ message.content }}</div>
            <div class="message-meta">
              <span class="message-time">{{ message.timestamp }}</span>
              <span class="message-status">{{ getStatusIcon(message.status) }}</span>
            </div>
          </div>
        </div> -->

        <div class="message-input-area">
          <!-- <div class="message-type-selector">
            <button
              class="type-button"
              [class.active]="messageType === 'text'"
              (click)="messageType = 'text'"
            >
              üìù Texto
            </button>
            <button
              class="type-button"
              [class.active]="messageType === 'image'"
              (click)="messageType = 'image'"
            >
              üñºÔ∏è Imagem
            </button>
            <button
              class="type-button"
              [class.active]="messageType === 'document'"
              (click)="messageType = 'document'"
            >
              üìÑ Documento
            </button>
          </div> -->

          <div class="input-container" *ngIf="messageType === 'text'">
            <textarea
              [(ngModel)]="messageContent"
              placeholder="Digite sua mensagem..."
              class="message-textarea"
              rows="3"
              (keydown.enter)="sendMessage()"
            ></textarea>
            <div class="character-count">
              {{ messageContent.length }}/4096 caracteres
            </div>
          </div>

          <!-- <div class="file-upload-area" *ngIf="messageType === 'image' || messageType === 'document'">
            <div class="upload-zone" (click)="fileInput.click()">
              <div class="upload-icon">
                {{ messageType === 'image' ? 'üñºÔ∏è' : 'üìÑ' }}
              </div>
              <p>Clique para selecionar {{ messageType === 'image' ? 'uma imagem' : 'um documento' }}</p>
              <input
                #fileInput
                type="file"
                [accept]="messageType === 'image' ? 'image/*' : '.pdf,.doc,.docx,.txt'"
                (change)="onFileSelected($event)"
                style="display: none"
              />
            </div>
            <div class="selected-file" *ngIf="selectedFile">
              <span>{{ selectedFile.name }}</span>
              <button (click)="selectedFile = null">√ó</button>
            </div>
          </div> -->

          <div class="message-actions">
            <!-- <button class="btn-secondary" (click)="scheduleMessage()" [disabled]="!canSendMessage()">
              ‚è∞ Agendar
            </button> -->
            <button class="btn-primary" (click)="sendMessage()" [disabled]="!canSendMessage()">
              üì§ Enviar
            </button>
          </div>
        </div>
      </div>

      <div class="empty-composer" *ngIf="!selectedRecipient">
        <div class="empty-icon" [innerHTML]="getWhatsAppIcon()" [attr.aria-hidden]="true"></div>
        <h3>Selecione um contato ou grupo</h3>
        <p>Escolha um destinat√°rio na lista ao lado para come√ßar a enviar mensagens</p>
      </div>
    </div>
    </ng-container>

    <!-- Mensagem quando desconectado -->
    <ng-template #disconnectedMessage>
      <div class="disconnected-message">
        <div class="disconnected-icon" [innerHTML]="getWhatsAppIcon()" [attr.aria-hidden]="true"></div>
        <h3>Conecte-se √† API WhatsApp</h3>
        <p>Para enviar mensagens, voc√™ precisa estar conectado √† API externa do WhatsApp e logado com um n√∫mero.</p>
      </div>
    </ng-template>
  </div>

  <!-- Modal Adicionar Contato -->
  <app-modal
    [title]="'Novo Contato'"
    [isOpen]="showAddContactModal"
    [size]="'small'"
    [footerButtons]="getContactModalButtons()"
    (close)="closeAddContactModal()">
    
    <form (ngSubmit)="addContact()">
      <div class="form-section">
        <h4 class="section-title">Informa√ß√µes do Contato</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>Nome <span class="required">*</span></label>
            <input
              type="text"
              [(ngModel)]="newContact.name"
              name="name"
              class="form-control"
              placeholder="Nome do contato"
              required
            />
          </div>

          <div class="form-group">
            <label>Telefone <span class="required">*</span></label>
            <input
              type="tel"
              [(ngModel)]="newContact.phone"
              name="phone"
              class="form-control"
              placeholder="+55 11 99999-9999"
              required
            />
          </div>
        </div>
      </div>
    </form>
  </app-modal>

  <!-- Modal Adicionar Grupo -->
  <app-modal
    [title]="'Novo Grupo'"
    [isOpen]="showAddGroupModal"
    [size]="'medium'"
    [footerButtons]="getGroupModalButtons()"
    (close)="closeAddGroupModal()">
    
    <form (ngSubmit)="addGroup()">
      <div class="form-section">
        <h4 class="section-title">Informa√ß√µes do Grupo</h4>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Nome do Grupo <span class="required">*</span></label>
            <input
              type="text"
              [(ngModel)]="newGroup.name"
              name="name"
              class="form-control"
              placeholder="Nome do grupo"
              required
            />
          </div>

          <div class="form-group full-width">
            <label>Descri√ß√£o</label>
            <textarea
              [(ngModel)]="newGroup.description"
              name="description"
              class="form-control"
              placeholder="Descri√ß√£o do grupo"
              rows="3"
            ></textarea>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h4 class="section-title">Selecionar Membros <span class="required">*</span></h4>
        <div class="members-selector">
          @for (contact of contacts; track contact.id) {
            <div
              class="member-item"
              (click)="toggleMember(contact)"
              [class.selected]="isMemberSelected(contact)"
            >
              <div class="member-avatar">{{ contact.name.charAt(0) }}</div>
              <div class="member-info">
                <div class="member-name">{{ contact.name }}</div>
                <div class="member-phone">{{ contact.id.replace('@s.whatsapp.net','') }}</div>
              </div>
              <div class="member-checkbox">
                @if (isMemberSelected(contact)) {
                  <span>‚úì</span>
                }
              </div>
            </div>
          }
        </div>
        <small class="form-hint">Selecione pelo menos um membro para criar o grupo</small>
      </div>
    </form>
  </app-modal>

  <!-- Modal Informa√ß√µes do Destinat√°rio -->
  <app-modal
    [title]="'Informa√ß√µes do Destinat√°rio'"
    [isOpen]="showRecipientInfo"
    [size]="'medium'"
    [footerButtons]="getRecipientInfoModalButtons()"
    (close)="showRecipientInfo = false">
    
    @if (selectedRecipient) {
      <div class="detail-section">
        <h4 class="section-title">Informa√ß√µes B√°sicas</h4>
        <div class="details-grid">
          <div class="detail-item full-width">
            <label>Nome</label>
            <span>{{ selectedRecipient.name || 'N√£o informado' }}</span>
          </div>
          @if (selectedRecipient.type === 'contact') {
            <div class="detail-item">
              <label>Telefone</label>
              <span>{{ selectedRecipient.phone || 'N√£o informado' }}</span>
            </div>
          }
          @if (selectedRecipient.type === 'group') {
            <div class="detail-item full-width">
              <label>Descri√ß√£o</label>
              <span>{{ selectedRecipient.description || 'N√£o informado' }}</span>
            </div>
            <div class="detail-item">
              <label>Total de Membros</label>
              <span>{{ selectedRecipient.members?.length || 0 }}</span>
            </div>
          }
        </div>
      </div>

      @if (selectedRecipient.type === 'group' && selectedRecipient.members && selectedRecipient.members.length > 0) {
        <div class="detail-section">
          <h4 class="section-title">Membros do Grupo</h4>
          <div class="tags-list">
            @for (member of selectedRecipient.members; track member.id) {
              <span class="tag">{{ member.name }}</span>
            }
          </div>
        </div>
      }
    }
  </app-modal>

  <!-- Modal de Login WhatsApp -->
  <app-modal
    [title]="'Login WhatsApp'"
    [isOpen]="showLoginModal"
    [size]="'medium'"
    [closeOnOverlayClick]="false"
    (close)="closeLoginModal()">
    <app-whatsapp-login-modal
      (close)="closeLoginModal()"
      (loginSuccess)="handleLoginSuccess()"
    ></app-whatsapp-login-modal>
  </app-modal>
</div>
