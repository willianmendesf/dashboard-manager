<pagetitle title="Gerenciamento de Grupos" subtitle="Gerencie os grupos de voluntariado e atividades"></pagetitle>

<!-- Tabs -->
<div class="filter-tabs">
  <button 
    class="tab-button" 
    [class.active]="activeTab === 'groups'"
    (click)="switchTab('groups')"
  >
    Grupos
  </button>
  <button 
    class="tab-button" 
    [class.active]="activeTab === 'approvals'"
    (click)="switchTab('approvals')"
  >
    Aprovações
    @if (pendingEnrollments.length > 0) {
      <span class="badge-count">{{ pendingEnrollments.length }}</span>
    }
  </button>
  <button 
    class="tab-button" 
    [class.active]="activeTab === 'members'"
    (click)="switchTab('members')"
  >
    Membros por Grupo
  </button>
</div>

<!-- Aba Grupos -->
@if (activeTab === 'groups') {
  <div class="content-card">
    <div class="toolbar">
      <div class="search-box">
        <input
          type="text"
          class="form-control"
          placeholder="Buscar grupos..."
          [(ngModel)]="searchTerm"
          (input)="filterGroups()"
        />
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        + Novo Grupo
      </button>
    </div>

    <app-data-table
      [columns]="tableColumns"
      [data]="filteredGroupsData"
      [actions]="getTableActions()"
      [loading]="isLoading"
      emptyMessage="Nenhum grupo encontrado"
    ></app-data-table>
  </div>
}

<!-- Aba Aprovações -->
@if (activeTab === 'approvals') {
  <div class="content-card">
    <!-- Sub-tabs -->
    <div class="sub-tabs">
      <button 
        class="sub-tab-button" 
        [class.active]="approvalSubTab === 'pending'"
        (click)="switchApprovalSubTab('pending')"
      >
        Pendentes
        @if (pendingEnrollments.length > 0) {
          <span class="badge-count">{{ pendingEnrollments.length }}</span>
        }
      </button>
      <button 
        class="sub-tab-button" 
        [class.active]="approvalSubTab === 'history'"
        (click)="switchApprovalSubTab('history')"
      >
        Histórico
      </button>
    </div>

    <!-- Tabela Pendentes -->
    @if (approvalSubTab === 'pending') {
      <app-data-table
        [columns]="approvalsColumns"
        [data]="filteredApprovalsData"
        [actions]="getApprovalsTableActions()"
        [loading]="isLoadingApprovals"
        emptyMessage="Nenhuma solicitação pendente"
      >
        <ng-template #rowTemplate let-row let-column="column">
          @if (column.key === 'foto') {
            <img 
              [src]="getEnrollmentImageUrl(row._original)" 
              class="avatar-small"
              alt="Foto"
              onerror="this.src='./img/avatar-default.png'"
            />
          } @else if (column.key === 'whatsapp') {
            @if (getEnrollmentWhatsAppLink(row._original)) {
              <a 
                [href]="getEnrollmentWhatsAppLink(row._original)!" 
                target="_blank" 
                class="whatsapp-link"
                [innerHTML]="getWhatsAppIcon()"
                title="Abrir no WhatsApp"
              ></a>
            } @else {
              <span class="text-muted">-</span>
            }
          } @else {
            {{ row[column.key] || '-' }}
          }
        </ng-template>
      </app-data-table>
    }

    <!-- Tabela Histórico -->
    @if (approvalSubTab === 'history') {
      <app-data-table
        [columns]="historyColumns"
        [data]="filteredHistoryData"
        [actions]="getHistoryTableActions()"
        [loading]="isLoadingHistory"
        emptyMessage="Nenhum registro no histórico"
      >
        <ng-template #rowTemplate let-row let-column="column">
          @if (column.key === 'foto') {
            <img 
              [src]="getEnrollmentImageUrl(row._original)" 
              class="avatar-small"
              alt="Foto"
              onerror="this.src='./img/avatar-default.png'"
            />
          } @else if (column.key === 'status') {
            <span 
              class="status-badge" 
              [class.approved]="row._original.status === 'APPROVED'"
              [class.rejected]="row._original.status === 'REJECTED'"
            >
              {{ row.status }}
            </span>
          } @else if (column.key === 'whatsapp') {
            @if (getEnrollmentWhatsAppLink(row._original)) {
              <a 
                [href]="getEnrollmentWhatsAppLink(row._original)!" 
                target="_blank" 
                class="whatsapp-link"
                [innerHTML]="getWhatsAppIcon()"
                title="Abrir no WhatsApp"
              ></a>
            } @else {
              <span class="text-muted">-</span>
            }
          } @else {
            {{ row[column.key] || '-' }}
          }
        </ng-template>
      </app-data-table>
    }
  </div>
}

<!-- Aba Membros -->
@if (activeTab === 'members') {
  <div class="content-card">
    <div class="toolbar">
      <div class="search-box">
        <input
          type="text"
          class="form-control"
          placeholder="Buscar por nome..."
          [(ngModel)]="memberSearchTerm"
          (input)="filterMembers()"
        />
      </div>
      <select 
        class="form-control filter-select" 
        [ngModel]="groupFilter"
        (ngModelChange)="onGroupFilterChange($event)"
      >
        <option [ngValue]="null">Todos os Grupos</option>
        @for (group of groups; track group.id) {
          <option [ngValue]="group.id">{{ group.nome }}</option>
        }
      </select>
    </div>

    <app-data-table
      [columns]="membersColumns"
      [data]="filteredMembersData"
      [actions]="getMembersTableActions()"
      [loading]="isLoadingMembers"
      emptyMessage="Nenhum membro encontrado"
    >
      <ng-template #rowTemplate let-row let-column="column">
        @if (column.key === 'foto') {
          <img 
            [src]="getMemberImageUrl(row._original)" 
            class="avatar-small"
            alt="Foto"
            onerror="this.src='./img/avatar-default.png'"
          />
        } @else if (column.key === 'grupos') {
          <div class="groups-badges">
            @if (row.grupos) {
              @for (enrollment of row.grupos; track enrollment.id) {
                <span class="group-badge">{{ enrollment.groupName }}</span>
              }
            }
          </div>
        } @else if (column.key === 'whatsapp') {
          @if (getMemberWhatsAppLink(row._original)) {
            <a 
              [href]="getMemberWhatsAppLink(row._original)!" 
              target="_blank" 
              class="whatsapp-link"
              [innerHTML]="getWhatsAppIcon()"
              title="Abrir no WhatsApp"
            ></a>
          } @else {
            <span class="text-muted">-</span>
          }
        } @else {
          {{ row[column.key] || '-' }}
        }
      </ng-template>
    </app-data-table>
  </div>
}

<!-- Modal Criar/Editar Grupo -->
<app-modal
  [title]="modalTitle"
  [isOpen]="showModal"
  [size]="'medium'"
  [footerButtons]="getModalButtons()"
  (close)="closeModal()"
>
  <div class="form-container">
    <div class="form-group">
      <label for="nome">Nome do Grupo *</label>
      <input
        type="text"
        id="nome"
        class="form-control"
        [(ngModel)]="currentGroup.nome"
        placeholder="Ex: Professor de EBD"
        maxlength="100"
      />
    </div>

    <div class="form-group">
      <label for="descricao">Descrição</label>
      <textarea
        id="descricao"
        class="form-control"
        [(ngModel)]="currentGroup.descricao"
        placeholder="Descrição opcional do grupo"
        rows="3"
      ></textarea>
    </div>
  </div>
</app-modal>

<!-- Modal Rejeitar Solicitação -->
<app-modal
  title="Rejeitar Solicitação"
  [isOpen]="showRejectModal"
  [size]="'medium'"
  [footerButtons]="getRejectModalButtons()"
  (close)="closeRejectModal()"
>
  @if (selectedEnrollment) {
    <div class="form-container">
      <p>Tem certeza que deseja rejeitar a solicitação de <strong>{{ selectedEnrollment.memberName }}</strong> para o grupo <strong>{{ selectedEnrollment.groupName }}</strong>?</p>
      
      <div class="form-group">
        <label>
          <input
            type="checkbox"
            [(ngModel)]="rejectJustify"
          />
          Justificar rejeição
        </label>
      </div>

      @if (rejectJustify) {
        <div class="form-group">
          <label for="rejectReason">Motivo da Rejeição *</label>
          <textarea
            id="rejectReason"
            class="form-control"
            [(ngModel)]="rejectReason"
            placeholder="Informe o motivo da rejeição..."
            rows="4"
          ></textarea>
        </div>
      }
    </div>
  }
</app-modal>

<!-- Modal Remover do Grupo -->
<app-modal
  title="Remover do Grupo"
  [isOpen]="showRemoveModal"
  [size]="'medium'"
  [footerButtons]="getRemoveModalButtons()"
  (close)="closeRemoveModal()"
>
  @if (selectedMember) {
    <div class="form-container">
      <p>Selecione de qual grupo deseja remover <strong>{{ selectedMember.nome }}</strong>:</p>
      
      <div class="form-group">
        @for (enrollment of getApprovedEnrollments(selectedMember); track enrollment.id) {
          <label class="radio-option">
            <input
              type="radio"
              [name]="'removeGroup_' + selectedMember.id"
              [value]="enrollment.id"
              [checked]="selectedEnrollmentToRemove?.id === enrollment.id"
              (change)="selectedEnrollmentToRemove = enrollment"
            />
            {{ enrollment.groupName }}
          </label>
        }
      </div>
    </div>
  }
</app-modal>