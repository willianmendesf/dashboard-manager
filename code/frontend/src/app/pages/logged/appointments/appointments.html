<div class="page-container">
  <pagetitle title="Agendamentos" subtitle="Gerencie seus agendamentos"></pagetitle>

  <!-- Tabs -->
  <div class="filter-tabs">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'list'"
      (click)="switchTab('list')"
    >
      Lista de Agendamentos
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'logs'"
      (click)="switchTab('logs')"
    >
      Logs de Execução
    </button>
  </div>

  <!-- Conteúdo da aba Lista -->
  @if (activeTab === 'list') {
  <div class="actions-bar">
    <div class="search-filters">
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="filterAppointments()"
          placeholder="Buscar agendamentos..."
        />
        <div class="search-icon" [innerHTML]="getSearchIcon()" [attr.aria-hidden]="true"></div>
      </div>
      <select [(ngModel)]="statusFilter" (change)="filterAppointments()" class="filter-select">
        <option value="">Todos os Status</option>
        <option value="active">Ativos</option>
        <option value="paused">Pausados</option>
      </select>
    </div>
    <button class="btn-primary" (click)="openAppointmentModal()">+ Novo Agendamento</button>
  </div>

  <div class="projects-grid">
    <div class="project-card" *ngFor="let appointment of filteredAppointments" (click)="view(appointment)" style="cursor: pointer;">
      <div class="project-header">
        <h3>{{ appointment.name }}</h3>
        <div class="project-status-container">
          @if(appointment.enabled) {
          <div class="project-status status-active-prominent">
            {{ getStatus(appointment.enabled) }}
          </div>
          } @else {
          <div class="project-status status-paused">
            {{ getStatus(appointment.enabled) }}
          </div>
          }
          @if(appointment.taskType) {
          <div class="project-status" [class.status-api]="appointment.taskType === 'API_CALL'" [class.status-whatsapp]="appointment.taskType === 'WHATSAPP_MESSAGE'" [class.status-prayer360]="appointment.taskType === 'PRAYER360_DISTRIBUTION'">
            {{ getTaskTypeLabel(appointment.taskType) }}
          </div>
          }
          @if(appointment.development) {
          <div class="project-status status-dev">
            {{ getDevelopment(appointment.development) }}
          </div>
          }
          @if(appointment.isSystemAppointment) {
          <div class="project-status status-system">
            Sistema
          </div>
          }
        </div>
      </div>

      <div class="project-content-wrapper">
        <div class="project-content-left">
          <div class="team-avatars">
            <p class="project-description">{{ appointment.description || 'Sem descrição' }}</p>
          </div>
          @if(appointment.taskType === 'WHATSAPP_MESSAGE') {
          <div class="project-destination">
            <span class="destination-label">Destino:</span>
            <span class="destination-value">{{ getDestinationText(appointment) }}</span>
          </div>
          }
        </div>
        @if(appointment.taskType === 'WHATSAPP_MESSAGE' && appointment.sendImage && appointment.imageToSend) {
        <div class="project-image-preview">
          <img [src]="env + 'images/' + appointment.imageToSend" alt="Preview da imagem" />
        </div>
        } @else {
        <div class="project-image-preview project-image-placeholder"></div>
        }
      </div>

      <div class="project-footer">
        <div class="project-dates">
          <div class="date-item">
            <span class="date-label">Quando Enviar?</span>
            <span class="date-value">{{ appointment.schedule }}</span>
          </div>
          <div class="date-item">
            <span class="date-label">Data de início:</span>
            <span class="date-value">{{ appointment.startDate ? (appointment.startDate | date:'dd/MM/yyyy') : 'Não definida' }}</span>
          </div>
          <div class="date-item">
            <span class="date-label">Data de fim:</span>
            <span class="date-value">{{ appointment.endDate ? (appointment.endDate | date:'dd/MM/yyyy') : 'Não definida' }}</span>
          </div>
        </div>
      </div>
      <div class="action-buttons" (click)="$event.stopPropagation()">
        <button class="btn-action view" (click)="view(appointment)" title="Visualizar" [innerHTML]="getIcon('view')" [attr.aria-label]="'Visualizar'"></button>
        <button class="btn-action edit" (click)="edit(appointment)" title="Editar" [innerHTML]="getIcon('edit')" [attr.aria-label]="'Editar'"></button>
        <button class="btn-action delete" (click)="deleteItem(appointment)" title="Excluir" [innerHTML]="getIcon('delete')" [attr.aria-label]="'Excluir'" [disabled]="appointment.isSystemAppointment" [class.disabled]="appointment.isSystemAppointment"></button>
      </div>
    </div>
   
    <!-- View Modal -->
    <app-modal
      [title]="'Detalhes do Agendamento'"
      [isOpen]="showViewModal"
      [size]="'medium'"
      [footerButtons]="getViewModalButtons()"
      (close)="closeViewModal()">
      
      @if (viewingAppointment) {
        <div class="detail-section">
          <h4 class="section-title">Informações Básicas</h4>
          <div class="details-grid">
            <div class="detail-item">
              <label>Nome do Agendamento</label>
              <span>{{ viewingAppointment.name || 'Não informado' }}</span>
            </div>
            <div class="detail-item">
              <label>Descrição</label>
              <span>{{ viewingAppointment.description || 'Não informado' }}</span>
            </div>
            <div class="detail-item">
              <label>Agendamento (CRON)</label>
              <span class="cron-display">{{ viewingAppointment.schedule || 'Não configurado' }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4 class="section-title">Status e Configurações</h4>
          <div class="details-grid">
            <div class="detail-item">
              <label>Ativo para envio?</label>
              <span class="badge" [class.active]="viewingAppointment.enabled" [class.inactive]="!viewingAppointment.enabled">
                {{ viewingAppointment.enabled ? 'Sim' : 'Não' }}
              </span>
            </div>
            <div class="detail-item">
              <label>Modo Desenvolvimento?</label>
              <span class="badge" [class.active]="viewingAppointment.development" [class.inactive]="!viewingAppointment.development">
                {{ viewingAppointment.development ? 'Sim' : 'Não' }}
              </span>
            </div>
            <div class="detail-item">
              <label>Tipo de Envio</label>
              <span>{{ viewingAppointment.taskType === 'API_CALL' ? 'Acionar uma API' : 'WhatsApp Message' }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4 class="section-title">Datas</h4>
          <div class="details-grid">
            <div class="detail-item">
              <label>Data de Início</label>
              <span>{{ viewingAppointment.startDate ? (viewingAppointment.startDate | date:'dd/MM/yyyy') : 'Não definida' }}</span>
            </div>
            <div class="detail-item">
              <label>Data de Fim</label>
              <span>{{ viewingAppointment.endDate ? (viewingAppointment.endDate | date:'dd/MM/yyyy') : 'Não definida' }}</span>
            </div>
          </div>
        </div>

        @if (viewingAppointment.taskType === 'API_CALL') {
          <div class="detail-section">
            <h4 class="section-title">Configuração da API</h4>
            <div class="details-grid">
              <div class="detail-item full-width">
                <label>Endpoint</label>
                <span class="endpoint-url">{{ viewingAppointment.endpoint || 'Não configurado' }}</span>
              </div>
              <div class="detail-item">
                <label>Tentativas</label>
                <span>{{ viewingAppointment.retries || 3 }}</span>
              </div>
              <div class="detail-item">
                <label>Timeout (ms)</label>
                <span>{{ viewingAppointment.timeout || 30000 }}</span>
              </div>
            </div>
          </div>
        } @else {
          <div class="detail-section">
            <h4 class="section-title">Mensagem WhatsApp</h4>
            <div class="details-grid">
              <div class="detail-item full-width">
                <label>Mensagem</label>
                <span class="message-text">{{ viewingAppointment.message || 'Não configurada' }}</span>
              </div>
              <div class="detail-item">
                <label>Enviar Imagem?</label>
                <span class="badge" [class.active]="viewingAppointment.sendImage" [class.inactive]="!viewingAppointment.sendImage">
                  {{ viewingAppointment.sendImage ? 'Sim' : 'Não' }}
                </span>
              </div>
            </div>
            @if (viewingAppointment.sendImage && viewingAppointment.imageToSend) {
              <div class="image-preview">
                <label>Imagem</label>
                <img [src]="env + 'images/' + viewingAppointment.imageToSend" alt="Imagem do agendamento" />
              </div>
            }
            @if (viewingAppointment.sendToGroups && viewingAppointment.sendToGroups.length > 0) {
              <div class="detail-section">
                <h4 class="section-title">Grupos de Destino</h4>
                <div class="tags-list">
                  @for (groupId of viewingAppointment.sendToGroups; track groupId) {
                    <span class="tag">{{ getGroupName(groupId) }}</span>
                  }
                </div>
              </div>
            }
            @if (viewingAppointment.sendTo && viewingAppointment.sendTo.length > 0) {
              <div class="detail-section">
                <h4 class="section-title">Contatos de Destino</h4>
                <div class="tags-list">
                  @for (contactId of viewingAppointment.sendTo; track contactId) {
                    <span class="tag">{{ getContactName(contactId) }}</span>
                  }
                </div>
              </div>
            }
          </div>
        }

        <div class="detail-section">
          <h4 class="section-title">Monitoramento</h4>
          <div class="details-grid">
            <div class="detail-item">
              <label>Monitoramento Individual?</label>
              <span class="badge" [class.active]="viewingAppointment.monitoring" [class.inactive]="!viewingAppointment.monitoring">
                {{ viewingAppointment.monitoring ? 'Sim' : 'Não' }}
              </span>
            </div>
            <div class="detail-item">
              <label>Monitoramento via Grupo?</label>
              <span class="badge" [class.active]="viewingAppointment.monitoringGroups" [class.inactive]="!viewingAppointment.monitoringGroups">
                {{ viewingAppointment.monitoringGroups ? 'Sim' : 'Não' }}
              </span>
            </div>
          </div>
          @if (viewingAppointment.monitoring && viewingAppointment.monitoringNumbers && viewingAppointment.monitoringNumbers.length > 0) {
            <div class="tags-list">
              <label>Contatos Monitorados:</label>
              @for (contactId of viewingAppointment.monitoringNumbers; track contactId) {
                <span class="tag">{{ getContactName(contactId) }}</span>
              }
            </div>
          }
          @if (viewingAppointment.monitoringGroups && viewingAppointment.monitoringGroupsIds && viewingAppointment.monitoringGroupsIds.length > 0) {
            <div class="tags-list">
              <label>Grupos Monitorados:</label>
              @for (groupId of viewingAppointment.monitoringGroupsIds; track groupId) {
                <span class="tag">{{ getGroupName(groupId) }}</span>
              }
            </div>
          }
        </div>
      }
    </app-modal>

    <!-- Edit/Create Modal -->
    <app-modal
      [title]="isEditing ? 'Editar Agendamento' : 'Novo Agendamento'"
      [isOpen]="showAppointmentModal"
      [size]="'xlarge'"
      [footerButtons]="getEditModalButtons()"
      (close)="closeModal()">
      
      <form (ngSubmit)="save()">
        <div class="form-section">
          <h4 class="section-title">Informações Básicas</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Nome do Agendamento <span class="required">*</span></label>
              <input type="text" [(ngModel)]="currentAppointment.name" name="name" class="form-control" required />
            </div>
            <div class="form-group">
              <label>Descrição <span class="required">*</span></label>
              <input type="text" [(ngModel)]="currentAppointment.description" name="description" class="form-control" required />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 class="section-title">Agendamento (CRON)</h4>
          <div class="form-grid">
            <div class="form-group full-width">
              <cron-selector [(currentAppointment)]="currentAppointment" [uniqueId]="'appointment-cron'"></cron-selector>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 class="section-title">Status</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Ativo para envio? <span class="required">*</span></label>
              <select [(ngModel)]="currentAppointment.enabled" name="enabled" class="form-control" required>
                <option [value]="true">Sim</option>
                <option [value]="false">Não</option>
              </select>
            </div>
            <div class="form-group">
              <label>Modo Desenvolvimento? <span class="required">*</span></label>
              <select [(ngModel)]="currentAppointment.development" name="development" class="form-control" required>
                <option [value]="true">Sim</option>
                <option [value]="false">Não</option>
              </select>
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 class="section-title">Período</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Data de Início</label>
              <input type="date" [(ngModel)]="currentAppointment.startDate" name="startDate" class="form-control" />
            </div>
            <div class="form-group">
              <label>Data de Fim</label>
              <input type="date" [(ngModel)]="currentAppointment.endDate" name="endDate" class="form-control" />
            </div>
          </div>
        </div>

        <div class="form-section">
          <h4 class="section-title">Tipo de Envio</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Tipo de Envio? <span class="required">*</span></label>
              <select [(ngModel)]="currentAppointment.taskType" name="taskType" class="form-control" required>
                <option [value]="'WHATSAPP_MESSAGE'">WhatsApp Message</option>
                <option [value]="'API_CALL'">Acionar uma API</option>
              </select>
            </div>
          </div>
        </div>

        @if (currentAppointment.taskType === "API_CALL") {
          <div class="form-section">
            <h4 class="section-title">Configuração da API</h4>
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Endpoint da API</label>
                <input type="text" [(ngModel)]="currentAppointment.endpoint" name="endpoint" class="form-control" placeholder="https://exemplo.com/api" />
              </div>
              <div class="form-group">
                <label>Tentativas</label>
                <input type="number" [(ngModel)]="currentAppointment.retries" name="retries" class="form-control" min="1" max="10" />
              </div>
              <div class="form-group">
                <label>Timeout (ms)</label>
                <input type="number" [(ngModel)]="currentAppointment.timeout" name="timeout" class="form-control" min="1000" />
              </div>
            </div>
          </div>
        } @else {
          <div class="form-section">
            <h4 class="section-title">Mensagem WhatsApp</h4>
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Mensagem a ser enviada</label>
                <textarea class="form-control" [(ngModel)]="currentAppointment.message" name="message" rows="4" placeholder="Digite a mensagem..."></textarea>
              </div>
            </div>
            <div class="form-grid">
              <div class="form-group">
                <label>Enviar Imagem? <span class="required">*</span></label>
                <select [(ngModel)]="currentAppointment.sendImage" name="sendImage" class="form-control" required>
                  <option [value]="true">Sim</option>
                  <option [value]="false">Não</option>
                </select>
              </div>
            </div>
            @if (currentAppointment.sendImage) {
              <div class="form-grid">
                <div class="form-group full-width">
                  <label>Imagem</label>
                  <image-upload (imagePath)="onImageUploaded($event)"></image-upload>
                  @if (currentAppointment.imageToSend) {
                    <div class="image-preview">
                      <img [src]="env + 'images/' + currentAppointment.imageToSend" alt="Preview" />
                    </div>
                  }
                </div>
              </div>
            }
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Tipo de Destinatário <span class="required">*</span></label>
                <select [(ngModel)]="currentAppointment.recipientType" name="recipientType" class="form-control" required (ngModelChange)="onRecipientTypeChange()">
                  <option value="INDIVIDUAL">Contatos Individuais</option>
                  <option value="GROUP">Grupos</option>
                </select>
              </div>
            </div>
            @if (currentAppointment.recipientType === "INDIVIDUAL") {
              <div class="form-grid">
                <div class="form-group full-width">
                  <label>Enviar Para Contato(s) <span class="required">*</span></label>
                  <select [(ngModel)]="currentAppointment.sendTo" name="sendTo" class="form-control" multiple required>
                    <option *ngFor="let item of contacts" [ngValue]="item.id">
                      {{ item.name || item.id }}
                    </option>
                  </select>
                  <small class="form-hint">Mantenha Ctrl (ou Cmd no Mac) pressionado para selecionar múltiplos contatos</small>
                </div>
              </div>
            }
            @if (currentAppointment.recipientType === "GROUP") {
              <div class="form-grid">
                <div class="form-group full-width">
                  <label>Enviar Para o(s) Grupo(s) <span class="required">*</span></label>
                  <select [(ngModel)]="currentAppointment.sendToGroups" name="sendToGroups" class="form-control" multiple required>
                    <option *ngFor="let item of groups" [ngValue]="item.id">
                      {{ item.name }}
                    </option>
                  </select>
                  <small class="form-hint">Mantenha Ctrl (ou Cmd no Mac) pressionado para selecionar múltiplos grupos</small>
                </div>
              </div>
            }
          </div>
        }

        <div class="form-section">
          <h4 class="section-title">Monitoramento</h4>
          <div class="form-grid">
            <div class="form-group">
              <label>Monitoramento via Individual? <span class="required">*</span></label>
              <select [(ngModel)]="currentAppointment.monitoring" name="monitoring" class="form-control" required>
                <option [value]="true">Sim</option>
                <option [value]="false">Não</option>
              </select>
            </div>
            <div class="form-group">
              <label>Monitoramento via Grupo? <span class="required">*</span></label>
              <select [(ngModel)]="currentAppointment.monitoringGroups" name="monitoringGroups" class="form-control" required>
                <option [value]="true">Sim</option>
                <option [value]="false">Não</option>
              </select>
            </div>
          </div>
          @if (currentAppointment.monitoring) {
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Contatos para Monitorar</label>
                <select [(ngModel)]="currentAppointment.monitoringNumbers" [ngModelOptions]="{standalone: true}" name="monitoringNumbers" class="form-control" multiple>
                  <option *ngFor="let item of contacts" [ngValue]="item.id">
                    {{ item.name || item.id }}
                  </option>
                </select>
                <small class="form-hint">Mantenha Ctrl (ou Cmd no Mac) pressionado para selecionar múltiplos contatos</small>
              </div>
            </div>
          }
          @if (currentAppointment.monitoringGroups) {
            <div class="form-grid">
              <div class="form-group full-width">
                <label>Grupos para Monitorar</label>
                <select [(ngModel)]="currentAppointment.monitoringGroupsIds" [ngModelOptions]="{standalone: true}" name="monitoringGroupsIds" class="form-control" multiple>
                  <option *ngFor="let item of groups" [ngValue]="item.id">
                    {{ item.name }}
                  </option>
                </select>
                <small class="form-hint">Mantenha Ctrl (ou Cmd no Mac) pressionado para selecionar múltiplos grupos</small>
              </div>
            </div>
          }
        </div>
        </form>
    </app-modal>
  </div>
  }

  <!-- Conteúdo da aba Logs -->
  @if (activeTab === 'logs') {
  <div class="logs-section">
    <div class="logs-header">
      <h3>Histórico de Execuções</h3>
      <button class="btn-secondary" (click)="getExecutionLogs()">Atualizar</button>
    </div>
    
    <app-data-table
      [columns]="logColumns"
      [data]="getLogTableData()"
      [actions]="logActions"
      [loading]="false"
      emptyMessage="Nenhum log de execução encontrado"
      [striped]="true"
      [hoverable]="true"
    >
      <ng-template #rowTemplate let-row let-column="column">
        @if (column.key === 'status') {
          <span class="status-badge" [class.status-success]="row._original.status === 'SUCCESS'" 
                [class.status-failure]="row._original.status === 'FAILURE'"
                [class.status-pending]="row._original.status === 'PENDING'">
            {{ row.status }}
          </span>
        } @else if (column.key === 'errorMessage' && row._original.status === 'FAILURE') {
          <span class="error-message" [title]="row.errorMessage">
            {{ row.errorMessage }}
          </span>
        } @else {
          {{ row[column.key] }}
        }
      </ng-template>
    </app-data-table>
  </div>
  }
</div>